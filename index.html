<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Minesight Pro â€” See the board. Own the game.</title>
<meta name="description" content="Minesight Pro â€” professional Minesweeper with admin 'soft reveal' and enterprise admin panel." />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect rx='12' width='64' height='64' fill='%232b7cff'/%3E%3Ctext x='50%25' y='55%25' font-size='28' text-anchor='middle' fill='white' font-family='monospace' font-weight='700'%3EMP%3C/text%3E%3C/svg%3E">
<style>
  /* ---------- THEME & LAYOUT ---------- */
  :root{
    --bg: linear-gradient(180deg,#f6fbff,#eef6ff);
    --card: #ffffff; --muted:#6b7280; --text:#0f1724; --accent:#2b7cff;
    --cell:#eef6ff; --cell-border:#cddaf2; --danger:#ff4d4f; --flag:#ffb400;
    --glass: rgba(255,255,255,0.6);
    --radius:12px; --maxw:1200px;
  }
  [data-theme="dark"]{
    --bg: linear-gradient(180deg,#071026,#08142a);
    --card:#0c1724; --muted:#9aa7bf; --text:#e6eef6; --accent:#6aa8ff;
    --cell:#0b1220; --cell-border:#1f2937; --danger:#ff6b6b; --flag:#ffc870;
    --glass: rgba(10,16,26,0.6);
  }

  *{box-sizing:border-box}
  html,body{height:100%; margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  body{ background:var(--bg); color:var(--text); display:flex; align-items:center; justify-content:center; padding:28px; }
  main.app{ width:100%; max-width:var(--maxw); display:grid; grid-template-columns:360px 1fr; gap:20px; align-items:start; }

  .panel{ background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:0 10px 30px rgba(2,6,23,0.06); border:1px solid rgba(0,0,0,0.04); }
  header.top{ grid-column:1/-1; display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:6px; }
  .brand{ display:flex; gap:12px; align-items:center; }
  .logo-badge{ width:46px; height:46px; border-radius:10px; display:grid; place-items:center; color:white; font-weight:800; font-family:monospace; background:linear-gradient(180deg,var(--accent), color-mix(in srgb,var(--accent) 80%, black)); box-shadow:0 8px 26px rgba(43,124,255,0.12); }
  .title-block h1{ margin:0; font-size:18px; }
  .title-block p{ margin:2px 0 0; font-size:13px; color:var(--muted); }

  .btn{ padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:700; }
  .btn.primary{ background:linear-gradient(180deg,var(--accent), color-mix(in srgb,var(--accent) 85%, black)); color:white; box-shadow:0 6px 18px rgba(43,124,255,0.12); }
  .btn.ghost{ background:transparent; border:1px solid var(--cell-border); padding:8px 10px; border-radius:8px; color:var(--text); }

  /* CONTROLS LEFT */
  .controls{ display:flex; flex-direction:column; gap:12px; }
  label{ font-size:13px; color:var(--muted); margin-bottom:6px; display:block; }
  select,input[type=number],input[type=text]{ width:100%; padding:8px 10px; border-radius:8px; border:1px solid var(--cell-border); background:var(--cell); color:var(--text); }

  .stats{ display:flex; gap:8px; margin-top:6px; }
  .stat{ background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(255,255,255,0.02)); padding:8px 10px; border-radius:8px; min-width:92px; text-align:center; font-weight:700; border:1px solid var(--cell-border); }

  /* BOARD RIGHT */
  .board-shell{ display:flex; flex-direction:column; gap:12px; align-items:center; }
  .topbar{ width:100%; display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .status{ display:flex; gap:12px; align-items:center; }
  .pill{ background:var(--glass); padding:8px 12px; border-radius:10px; font-weight:800; border:1px solid rgba(255,255,255,0.04); min-width:92px; text-align:center; }

  .board-wrap{ background:transparent; padding:14px; border-radius:12px; min-height:320px; display:flex; align-items:center; justify-content:center; width:100%; }
  .board{ display:grid; gap:6px; touch-action: manipulation; }

  .cell{
    aspect-ratio:1/1; width:38px; display:flex; align-items:center; justify-content:center;
    background:var(--cell); border-radius:8px; border:1px solid var(--cell-border); font-weight:800; font-size:16px; color:var(--text);
    user-select:none; cursor:pointer; transition: transform .06s ease, background .12s ease, box-shadow .08s ease;
    box-shadow: inset 0 -2px 0 rgba(0,0,0,0.03);
    position:relative;
  }
  .cell:active{ transform:translateY(1px) scale(.995); }
  .cell.revealed{ background: linear-gradient(180deg,#f8fafc,#eef3ff); box-shadow:none; cursor:default; }
  [data-theme="dark"] .cell.revealed{ background: linear-gradient(180deg,#071226,#0d1826) }
  .cell.mine{ color:var(--danger); }
  .cell.flag{ color:var(--flag); }
  .cell[data-num="1"]{ color:#2563eb }
  .cell[data-num="2"]{ color:#16a34a }
  .cell[data-num="3"]{ color:#dc2626 }
  .cell[data-num="4"]{ color:#7c3aed }

  /* Soft-reveal overlay (admin "hack") */
  .cell.soft-mine::after{
    content: "ðŸ’£";
    position:absolute; inset:6px; display:grid; place-items:center;
    font-size:16px; pointer-events:none; opacity:0.95;
    border-radius:6px; background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.04);
  }
  .cell.soft-mine.soft-flagged::after{ content: "âš‘"; color:var(--flag); }

  /* ADMIN MODAL STYLES */
  .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000; }
  .modal.open{ display:flex; }
  .modal-card{ background:var(--card); width:780px; max-width:96%; border-radius:12px; padding:18px; box-shadow:0 20px 60px rgba(3,6,23,0.35); border:1px solid rgba(0,0,0,0.06); color:var(--text); }
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; align-items:start; }

  .audit-log{ max-height:220px; overflow:auto; background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(255,255,255,0.02)); padding:8px; border-radius:8px; border:1px solid var(--cell-border); font-size:13px; color:var(--muted); }

  /* Responsive */
  @media (max-width:980px){
    main.app{ grid-template-columns: 1fr; padding:12px; gap:12px; }
    .cell{ width:34px; }
  }
</style>
</head>
<body>
<main class="app" id="app">
  <!-- Header -->
  <header class="top panel" role="banner" aria-label="Minesight Pro header">
    <div class="brand">
      <div class="logo-badge" aria-hidden="true">MP</div>
      <div class="title-block">
        <h1>Minesight Pro</h1>
        <p>See the board. Own the game. Enterprise admin available</p>
      </div>
    </div>

    <div style="display:flex; gap:8px; align-items:center;">
      <select id="themeSelect" aria-label="Theme selector">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>

      <button id="newGameTop" class="btn primary" title="Start new game">New Game</button>
      <button id="openAdminBtn" class="btn ghost" title="Open Admin Panel">Admin Panel</button>
      <div id="adminBadge" style="display:none; padding:8px 10px; border-radius:8px; background:linear-gradient(180deg,#eef6ff,#f8fbff); border:1px solid var(--cell-border); font-weight:700; color:var(--muted)">Admin</div>
    </div>
  </header>

  <!-- LEFT: Controls -->
  <section class="panel controls" aria-label="Controls">
    <h2 style="margin:0 0 6px 0">Game Controls</h2>

    <div>
      <label for="modeSelect">Mode</label>
      <select id="modeSelect" aria-label="Choose difficulty mode">
        <option value="beginner">Beginner â€” 9 Ã— 9 Â· 10 mines</option>
        <option value="intermediate">Intermediate â€” 16 Ã— 16 Â· 40 mines</option>
        <option value="expert">Expert â€” 16 Ã— 30 Â· 99 mines</option>
        <option value="custom">Custom</option>
      </select>
    </div>

    <div id="customControls" style="display:none;">
      <label>Custom board</label>
      <div style="display:flex; gap:8px;">
        <input id="rowsInput" type="number" min="5" max="80" value="9" aria-label="Rows">
        <input id="colsInput" type="number" min="5" max="120" value="9" aria-label="Columns">
        <input id="minesInput" type="number" min="1" max="1000" value="10" aria-label="Mines">
      </div>
    </div>

    <div class="stats">
      <div class="stat" id="mineCount">Mines: 10</div>
      <div class="stat" id="flagCount">Flags: 0</div>
      <div class="stat" id="timer">Time: 0s</div>
    </div>

    <div style="display:flex; gap:8px; margin-top:8px;">
      <button id="startBtn" class="btn primary">Start</button>
      <button id="hintBtn" class="btn ghost">Hint</button>
    </div>

    <div style="margin-top:12px;">
      <label>Options</label>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <label style="font-size:13px;color:var(--muted);"><input type="checkbox" id="autoOpen" checked> Auto-open neighbors (chording)</label>
        <label style="font-size:13px;color:var(--muted);"><input type="checkbox" id="soundToggle" checked> Sound effects</label>
        <label style="font-size:13px;color:var(--muted);"><input type="checkbox" id="compactToggle"> Compact board</label>
      </div>
    </div>

    <div style="margin-top:12px;">
      <label>Leaderboard</label>
      <div id="leaderboard" style="display:flex; flex-direction:column; gap:8px; min-height:70px;"></div>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <input id="playerName" type="text" placeholder="Your name (leaderboard)" />
        <button id="clearLB" class="btn ghost">Clear</button>
      </div>
    </div>
  </section>

  <!-- RIGHT: Board -->
  <section class="panel board-shell" aria-label="Game board">
    <div class="topbar">
      <div class="status">
        <div class="pill" id="statusText">Ready</div>
        <div class="pill" id="boardInfo">9 Ã— 9 Â· Beginner</div>
      </div>

      <div style="display:flex; gap:8px; align-items:center;">
        <button id="showMinesToggle" class="btn ghost" title="Admin-only: soft-reveal mines">Soft-Show Mines</button>
        <button id="copyResult" class="btn ghost">Copy Result</button>
        <button id="resetHints" class="btn ghost">Reset Hints</button>
      </div>
    </div>

    <div id="boardWrap" class="board-wrap" role="application" aria-label="Minesight Pro board area">
      <div id="board" class="board" role="grid" tabindex="0" aria-label="Mines grid"></div>
    </div>

    <div style="display:flex; justify-content:space-between; width:100%; margin-top:6px;">
      <div style="display:flex; gap:8px;">
        <button id="undoBtn" class="btn ghost">Undo</button>
        <button id="compactView" class="btn ghost">Toggle Compact</button>
      </div>
      <div style="font-size:13px;color:var(--muted)">Minesight Pro Â· v1.1</div>
    </div>
  </section>
</main>

<!-- Admin login modal -->
<div class="modal" id="loginModal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-card">
    <h2>Admin Login</h2>
    <p style="color:var(--muted)">Enter administrator credentials to access the control center.</p>
    <div style="display:flex; gap:8px; margin-top:12px;">
      <input id="loginUser" placeholder="Username" />
      <input id="loginPass" placeholder="Password" type="password" />
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
      <button id="loginCancel" class="btn ghost">Cancel</button>
      <button id="loginSubmit" class="btn primary">Sign in</button>
    </div>
    <p style="margin-top:8px; font-size:13px; color:var(--muted)"><strong>Demo credentials:</strong> Sam / test</p>
  </div>
</div>

<!-- Admin panel modal -->
<div class="modal" id="adminModal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-card" aria-label="Admin Control Center">
    <header style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0">Admin Control Center</h2>
      <div style="display:flex; gap:8px; align-items:center;">
        <div id="adminUserBadge" style="font-weight:800;color:var(--muted)"></div>
        <button id="adminLogout" class="btn ghost">Logout</button>
      </div>
    </header>

    <div class="grid-2" style="margin-top:12px;">
      <div>
        <h3 style="margin:6px 0">Quick controls</h3>
        <label>Mode</label>
        <select id="adminMode">
          <option value="beginner">Beginner â€” 9Ã—9 Â· 10</option>
          <option value="intermediate">Intermediate â€” 16Ã—16 Â· 40</option>
          <option value="expert">Expert â€” 16Ã—30 Â· 99</option>
          <option value="custom">Custom</option>
        </select>

        <div id="adminCustom" style="margin-top:8px; display:none;">
          <label>Rows / Cols / Mines</label>
          <div style="display:flex;gap:8px;">
            <input id="adminRows" type="number" min="5" max="80" value="9" />
            <input id="adminCols" type="number" min="5" max="120" value="9" />
            <input id="adminMines" type="number" min="1" max="2000" value="10" />
          </div>
        </div>

        <div style="display:flex; gap:8px; margin-top:10px;">
          <button id="adminApply" class="btn primary">Apply</button>
          <button id="adminStart" class="btn ghost">Start Game</button>
        </div>

        <hr style="margin:12px 0">

        <h3 style="margin:6px 0">Visibility & hacks</h3>
        <label style="display:flex; gap:8px; align-items:center;"><input type="checkbox" id="softRevealToggle"> Show mines (soft) â€” show mines without losing</label>
        <label style="display:flex; gap:8px; align-items:center;"><input type="checkbox" id="confettiToggle" checked> Confetti on win</label>
        <label style="display:flex; gap:8px; align-items:center;"><input type="checkbox" id="muteToggle"> Mute sounds</label>

        <div style="margin-top:8px;">
          <button id="adminExportConfig" class="btn ghost">Export config</button>
          <input id="adminImportFile" type="file" accept="application/json" style="display:none" />
          <button id="adminImportBtn" class="btn ghost">Import config</button>
        </div>
      </div>

      <div>
        <h3 style="margin:6px 0">Audit log & leaderboard</h3>
        <div class="audit-log" id="auditLog"></div>

        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="exportLB" class="btn ghost">Export leaderboard</button>
          <button id="clearLBAdmin" class="btn ghost">Clear leaderboard</button>
          <button id="simulate" class="btn ghost">Simulate data</button>
        </div>

        <hr style="margin:12px 0">

        <h3 style="margin:6px 0">Danger zone</h3>
        <div style="display:flex; gap:8px;">
          <button id="forceReveal" class="btn ghost">Reveal mines (force lose)</button>
          <button id="resetAudit" class="btn ghost">Clear audit log</button>
        </div>
      </div>
    </div>

    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
      <button id="closeAdmin" class="btn ghost">Close</button>
    </div>
  </div>
</div>

<!-- Confetti canvas -->
<canvas id="confettiCanvas" style="position:fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:9999;"></canvas>

<script>
/*
  Minesight Pro â€” Admin "Soft Reveal" edition
  - Admin credentials (demo): Sam / test
  - Soft reveal: admin can show mines visually without causing a loss (non-destructive).
  - Admin session stored in sessionStorage (demo only).
  - Audit log stored in localStorage for persistence.
  - This is a client-side demo: for real production, enforce server-side auth & secure APIs.
*/

/* -------------------- Utilities & DOM refs -------------------- */
const UI = {
  // core
  boardEl: document.getElementById('board'),
  boardInfo: document.getElementById('boardInfo'),
  statusText: document.getElementById('statusText'),
  mineCount: document.getElementById('mineCount'),
  flagCount: document.getElementById('flagCount'),
  timerEl: document.getElementById('timer'),
  // controls
  modeSelect: document.getElementById('modeSelect'),
  customControls: document.getElementById('customControls'),
  rowsInput: document.getElementById('rowsInput'),
  colsInput: document.getElementById('colsInput'),
  minesInput: document.getElementById('minesInput'),
  startBtn: document.getElementById('startBtn'),
  hintBtn: document.getElementById('hintBtn'),
  autoOpenChk: document.getElementById('autoOpen'),
  soundToggle: document.getElementById('soundToggle'),
  compactToggle: document.getElementById('compactToggle'),
  playerName: document.getElementById('playerName'),
  leaderboardEl: document.getElementById('leaderboard'),
  clearLBBtn: document.getElementById('clearLB'),

  // header + admin
  themeSelect: document.getElementById('themeSelect'),
  newGameTop: document.getElementById('newGameTop'),
  openAdminBtn: document.getElementById('openAdminBtn'),
  adminBadge: document.getElementById('adminBadge'),
  showMinesToggle: document.getElementById('showMinesToggle'),
  copyResult: document.getElementById('copyResult'),
  resetHints: document.getElementById('resetHints'),
  compactView: document.getElementById('compactView'),
  undoBtn: document.getElementById('undoBtn'),

  // login + admin modal elements
  loginModal: document.getElementById('loginModal'),
  loginUser: document.getElementById('loginUser'),
  loginPass: document.getElementById('loginPass'),
  loginSubmit: document.getElementById('loginSubmit'),
  loginCancel: document.getElementById('loginCancel'),
  adminModal: document.getElementById('adminModal'),
  adminMode: document.getElementById('adminMode'),
  adminCustom: document.getElementById('adminCustom'),
  adminRows: document.getElementById('adminRows'),
  adminCols: document.getElementById('adminCols'),
  adminMines: document.getElementById('adminMines'),
  adminApply: document.getElementById('adminApply'),
  adminStart: document.getElementById('adminStart'),
  softRevealToggle: document.getElementById('softRevealToggle'),
  confettiToggle: document.getElementById('confettiToggle'),
  muteToggle: document.getElementById('muteToggle'),
  adminLogout: document.getElementById('adminLogout'),
  adminUserBadge: document.getElementById('adminUserBadge'),
  auditLogEl: document.getElementById('auditLog'),
  adminExportConfig: document.getElementById('adminExportConfig'),
  adminImportBtn: document.getElementById('adminImportBtn'),
  adminImportFile: document.getElementById('adminImportFile'),
  exportLB: document.getElementById('exportLB'),
  clearLBAdmin: document.getElementById('clearLBAdmin'),
  simulateBtn: document.getElementById('simulate'),
  forceRevealBtn: document.getElementById('forceReveal'),
  resetAuditBtn: document.getElementById('resetAudit'),
  closeAdmin: document.getElementById('closeAdmin'),
  showMinesButton: document.getElementById('showMinesToggle')
};

/* -------------------- Config & storage keys -------------------- */
const CONF = {
  leaderboardKey: 'minesight_pro_lb_v1',
  auditKey: 'minesight_pro_audit_v1',
  adminSessionKey: 'minesight_pro_admin_session_v1',
  defaultHints: 3
};

/* -------------------- Game state -------------------- */
let state = {
  rows: 9, cols: 9, mines: 10,
  grid: [], // {mine, revealed, flagged, num}
  started: false, startTime: 0, elapsed: 0, timerId: null,
  flagsLeft: 10, revealedCount: 0, gameOver: false, won: false,
  hintCount: CONF.defaultHints,
  compact: false,
  autoOpen: true,
  softReveal: false // admin-only soft reveal (visual, no loss)
};

/* -------------------- Small helpers -------------------- */
const nowISO = ()=> new Date().toISOString();
const logAudit = (action, detail='')=>{
  const entry = {ts: nowISO(), action, detail};
  const raw = localStorage.getItem(CONF.auditKey);
  const arr = raw ? JSON.parse(raw) : [];
  arr.unshift(entry);
  localStorage.setItem(CONF.auditKey, JSON.stringify(arr.slice(0,1000))); // keep recent
  renderAudit();
};
function setAdminSession(user){
  sessionStorage.setItem(CONF.adminSessionKey, JSON.stringify({user, ts: nowISO()}));
  UI.adminBadge.style.display = 'inline-block';
  UI.adminUserBadge.textContent = user;
  logAudit('admin_login', user);
}
function clearAdminSession(){
  sessionStorage.removeItem(CONF.adminSessionKey);
  UI.adminBadge.style.display = 'none';
  UI.adminUserBadge.textContent = '';
  logAudit('admin_logout', '');
}
function isAdmin(){ return !!sessionStorage.getItem(CONF.adminSessionKey); }

/* -------------------- Leaderboard -------------------- */
function loadLeaderboard(){ try{ return JSON.parse(localStorage.getItem(CONF.leaderboardKey) || '{}'); }catch(e){ return {}; } }
function saveLeaderboard(lb){ localStorage.setItem(CONF.leaderboardKey, JSON.stringify(lb)); }
function addLeaderboardEntry(mode, name, time){
  const lb = loadLeaderboard();
  if(!lb[mode]) lb[mode]=[];
  lb[mode].push({name, time, ts: nowISO()});
  lb[mode].sort((a,b)=>a.time-b.time);
  lb[mode] = lb[mode].slice(0,50);
  saveLeaderboard(lb);
  renderLeaderboard();
  logAudit('leaderboard_add', `${mode} ${name} ${time}s`);
}
function renderLeaderboard(){
  const mode = UI.modeSelect.value;
  const lb = loadLeaderboard()[mode] || [];
  UI.leaderboardEl.innerHTML = '';
  if(lb.length===0){ UI.leaderboardEl.textContent = 'No entries yet.'; return; }
  lb.slice(0,10).forEach((e,i)=> {
    const el = document.createElement('div');
    el.style.display='flex'; el.style.justifyContent='space-between';
    el.style.padding='6px'; el.style.borderRadius='6px'; el.style.background='linear-gradient(180deg, rgba(0,0,0,0.02), rgba(255,255,255,0.02))';
    el.innerHTML = `<div>${i+1}. ${escapeHtml(e.name)}</div><div style="font-weight:800">${e.time}s</div>`;
    UI.leaderboardEl.appendChild(el);
  });
}
function clearLeaderboard(){ localStorage.removeItem(CONF.leaderboardKey); renderLeaderboard(); logAudit('leaderboard_cleared','admin'); }

/* -------------------- Audit render -------------------- */
function renderAudit(){
  const raw = localStorage.getItem(CONF.auditKey);
  const arr = raw ? JSON.parse(raw) : [];
  UI.auditLogEl.innerHTML = '';
  if(arr.length===0){ UI.auditLogEl.textContent = 'No admin actions yet.'; return; }
  arr.slice(0,200).forEach(a=>{
    const d = document.createElement('div'); d.style.padding='6px'; d.style.borderBottom='1px solid rgba(0,0,0,0.04)';
    d.style.fontSize='13px'; d.style.color='var(--muted)';
    d.textContent = `${a.ts} â€” ${a.action} ${a.detail ? ' â€” ' + a.detail : ''}`;
    UI.auditLogEl.appendChild(d);
  });
}

/* -------------------- Grid helpers -------------------- */
function rcToIdx(r,c){ return r*state.cols + c; }
function idxToRC(i){ return [Math.floor(i/state.cols), i % state.cols]; }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* -------------------- Timer -------------------- */
function startTimer(){
  if(state.timerId) return;
  state.startTime = Date.now() - state.elapsed*1000;
  state.timerId = setInterval(()=> {
    state.elapsed = Math.floor((Date.now()-state.startTime)/1000);
    UI.timerEl.textContent = `Time: ${state.elapsed}s`;
  }, 500);
}
function stopTimer(){ if(state.timerId){ clearInterval(state.timerId); state.timerId = null; } }

/* -------------------- Create grid -------------------- */
function createGrid(rows, cols, mines){
  state.rows = rows; state.cols = cols; state.mines = mines;
  state.grid = Array.from({length:rows*cols}, ()=>({mine:false, revealed:false, flagged:false, num:0}));
  // place mines
  const indices = [...Array(rows*cols).keys()];
  shuffle(indices);
  indices.slice(0, mines).forEach(i=> state.grid[i].mine = true);
  // compute numbers
  for(let i=0;i<state.grid.length;i++){
    if(state.grid[i].mine) continue;
    const [r,c] = idxToRC(i);
    let cnt=0;
    for(let dr=-1; dr<=1; dr++) for(let dc=-1; dc<=1; dc++){
      if(dr===0 && dc===0) continue;
      const nr=r+dr, nc=c+dc;
      if(nr>=0 && nr<rows && nc>=0 && nc<cols) if(state.grid[rcToIdx(nr,nc)].mine) cnt++;
    }
    state.grid[i].num = cnt;
  }
  // reset play state
  state.started=false; stopTimer(); state.elapsed=0; state.revealedCount=0; state.flagsLeft=state.mines; state.gameOver=false; state.won=false;
  state.hintCount = CONF.defaultHints;
  UI.timerEl.textContent = `Time: 0s`;
  UI.mineCount.textContent = `Mines: ${state.mines}`;
  UI.flagCount.textContent = `Flags: ${state.mines - state.flagsLeft}`;
}

/* -------------------- Render board -------------------- */
function renderBoard(){
  UI.boardEl.innerHTML = '';
  UI.boardEl.style.gridTemplateColumns = `repeat(${state.cols}, ${state.compact ? '32px' : '38px'})`;
  UI.boardEl.style.gap = state.compact ? '4px' : '6px';
  for(let i=0;i<state.grid.length;i++){
    const cell = document.createElement('button');
    cell.className = 'cell';
    cell.setAttribute('data-idx', i);
    cell.setAttribute('role','gridcell');
    cell.tabIndex = 0;
    // events
    cell.addEventListener('click', ()=> onCellClick(i));
    cell.addEventListener('contextmenu', (e)=> { e.preventDefault(); toggleFlag(i); });
    cell.addEventListener('keydown', (e)=> {
      if(e.key==='Enter' || e.key===' ') { e.preventDefault(); onCellClick(i); }
      if(e.key.toLowerCase()==='f') { e.preventDefault(); toggleFlag(i); }
    });
    setupLongPress(cell, ()=> toggleFlag(i));
    UI.boardEl.appendChild(cell);
  }
  updateBoardVisuals();
  UI.boardInfo.textContent = `${state.rows} Ã— ${state.cols} Â· ${UI.modeSelect.options[UI.modeSelect.selectedIndex].text.split('â€”')[0].trim()}`;
}

/* -------------------- Update visuals (includes soft reveal) -------------------- */
function updateBoardVisuals(){
  for(let i=0;i<state.grid.length;i++){
    const g = state.grid[i];
    const el = UI.boardEl.querySelector(`.cell[data-idx='${i}']`);
    if(!el) continue;
    el.className = 'cell';
    el.removeAttribute('data-num');
    el.textContent = '';
    el.style.background = '';
    el.title = '';
    if(g.revealed){
      el.classList.add('revealed');
      if(g.mine){ el.classList.add('mine'); el.textContent = 'ðŸ’£'; el.title='Mine'; }
      else if(g.num>0){ el.textContent = g.num; el.setAttribute('data-num', g.num); el.title = `${g.num} adjacent mines`; }
      else { el.textContent = ''; el.title = 'No adjacent mines'; }
    } else {
      if(g.flagged){ el.classList.add('flag'); el.textContent = 'âš‘'; el.title='Flagged'; }
      // soft reveal overlay (admin-only non-destructive)
      if(state.softReveal && g.mine && isAdmin()){
        el.classList.add('soft-mine');
        if(g.flagged) el.classList.add('soft-flagged');
      } else {
        el.classList.remove('soft-mine');
        el.classList.remove('soft-flagged');
      }
    }
  }
  UI.mineCount.textContent = `Mines: ${state.mines}`;
  UI.flagCount.textContent = `Flags: ${state.mines - state.flagsLeft}`;
  UI.hintBtn.textContent = `Hint (${state.hintCount})`;
}

/* -------------------- Long-press (touch) -------------------- */
function setupLongPress(el, onLong){
  let t=null;
  el.addEventListener('touchstart', ()=> { t = setTimeout(()=> { onLong(); t=null; }, 650); });
  el.addEventListener('touchend', ()=> { if(t) clearTimeout(t); t=null; });
  el.addEventListener('touchmove', ()=> { if(t) clearTimeout(t); t=null; });
}

/* -------------------- Click / Reveal / Flag / Chording -------------------- */
function onCellClick(i){
  if(state.gameOver) return;
  const cell = state.grid[i];
  if(cell.flagged || cell.revealed){
    if(cell.revealed && UI.autoOpenChk.checked) chord(i);
    return;
  }
  if(!state.started){ state.started=true; startTimer(); }
  if(cell.mine){
    // clicked a mine: reveal all and lose
    revealMine(i);
    endGame(false);
    return;
  }
  // normal reveal
  floodReveal(i);
  checkWin();
  updateBoardVisuals();
}
function toggleFlag(i){
  if(state.gameOver) return;
  const cell = state.grid[i];
  if(cell.revealed) return;
  cell.flagged = !cell.flagged;
  state.flagsLeft += cell.flagged ? -1 : 1;
  logAudit('flag_toggled', `idx:${i} flagged:${cell.flagged}`);
  updateBoardVisuals();
  checkWin();
}
function chord(i){
  const c = state.grid[i];
  if(!c.revealed || c.num===0) return;
  const [r,c0] = idxToRC(i);
  let flagged=0, toReveal=[];
  for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
    if(dr===0 && dc===0) continue;
    const nr=r+dr, nc=c0+dc;
    if(nr>=0 && nr<state.rows && nc>=0 && nc<state.cols){
      const idx = rcToIdx(nr,nc);
      if(state.grid[idx].flagged) flagged++;
      else if(!state.grid[idx].revealed) toReveal.push(idx);
    }
  }
  if(flagged === state.grid[i].num){
    for(const idx of toReveal){
      if(state.grid[idx].mine){ revealMine(idx); endGame(false); return; }
      floodReveal(idx);
    }
    updateBoardVisuals();
  }
}
function revealMine(clicked){
  // reveal all mines visually and mark clicked cell red; this is a losing reveal
  for(let i=0;i<state.grid.length;i++){
    if(state.grid[i].mine) state.grid[i].revealed = true;
  }
  const el = UI.boardEl.querySelector(`.cell[data-idx='${clicked}']`);
  if(el) el.style.background = 'linear-gradient(180deg, rgba(255,0,0,0.09), rgba(255,0,0,0.02))';
  state.gameOver = true;
  stopTimer();
}
function floodReveal(startIdx){
  const q = [startIdx], visited = new Set();
  while(q.length){
    const cur = q.shift();
    if(visited.has(cur)) continue;
    const c = state.grid[cur];
    if(c.revealed || c.flagged) continue;
    c.revealed = true;
    state.revealedCount++;
    visited.add(cur);
    if(c.num === 0 && !c.mine){
      const [r,cc] = idxToRC(cur);
      for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
        if(dr===0 && dc===0) continue;
        const nr=r+dr, nc=cc+dc;
        if(nr>=0 && nr<state.rows && nc>=0 && nc<state.cols) {
          const ni = rcToIdx(nr,nc);
          if(!visited.has(ni) && !state.grid[ni].flagged) q.push(ni);
        }
      }
    }
  }
}

/* -------------------- Hints -------------------- */
function useHint(){
  if(state.hintCount <= 0 || state.gameOver) return;
  for(let i=0;i<state.grid.length;i++){
    const c = state.grid[i];
    if(!c.revealed && !c.mine && !c.flagged){
      if(!state.started){ state.started=true; startTimer(); }
      floodReveal(i);
      state.hintCount--;
      logAudit('hint_used', `idx:${i}`);
      updateBoardVisuals();
      checkWin();
      return;
    }
  }
}

/* -------------------- Win/Lose -------------------- */
function checkWin(){
  const total = state.rows * state.cols;
  if(state.revealedCount === total - state.mines){
    endGame(true);
  }
}
function endGame(won){
  state.gameOver = true;
  state.won = won;
  stopTimer();
  if(won){
    UI.statusText.textContent = `You win! ${state.elapsed}s`;
    if(isAdmin() ? document.getElementById('confettiToggle').checked : true) confettiBurst();
    addLeaderboardEntry(UI.modeSelect.value, UI.playerName.value || 'Anon', state.elapsed);
    logAudit('game_win', `${state.elapsed}s`);
  } else {
    UI.statusText.textContent = 'Boom! You lost';
    logAudit('game_lost', '');
  }
  updateBoardVisuals();
}

/* -------------------- Soft reveal (admin-only) -------------------- */
function setSoftReveal(enabled){
  state.softReveal = enabled;
  logAudit('soft_reveal', `enabled:${enabled}`);
  updateBoardVisuals();
}

/* -------------------- Undo (basic) -------------------- */
let lastAction = null;
function saveLastAction(action){ lastAction = action; }
function undo(){
  if(!lastAction) return;
  if(lastAction.type === 'reveal'){
    lastAction.indices.forEach(i=> { if(state.grid[i]) { state.grid[i].revealed=false; state.revealedCount = Math.max(0, state.revealedCount-1); } });
  } else if(lastAction.type==='flag'){
    const idx = lastAction.idx;
    if(state.grid[idx]) { state.grid[idx].flagged = !state.grid[idx].flagged; state.flagsLeft += state.grid[idx].flagged ? -1 : 1; }
  }
  lastAction = null;
  updateBoardVisuals();
}

/* -------------------- Copy result -------------------- */
function copyResult(){
  if(!state.started) return;
  const modeName = UI.modeSelect.options[UI.modeSelect.selectedIndex].text.split('â€”')[0].trim();
  const txt = `Minesight Pro ${modeName} â€” ${state.won? 'Win' : 'Loss'} â€” ${state.elapsed}s â€” ${state.rows}x${state.cols} â€¢ ${state.mines} mines`;
  navigator.clipboard?.writeText(txt).then(()=> {
    UI.copyResult.textContent = 'Copied!';
    setTimeout(()=> UI.copyResult.textContent = 'Copy Result', 1400);
  }).catch(()=> alert('Copy failed'));
}

/* -------------------- Keyboard navigation -------------------- */
let focusedIdx = 0;
document.addEventListener('keydown', (e)=>{
  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){
    e.preventDefault();
    moveFocus(e.key);
  }
  if(e.key.toLowerCase()==='f'){ e.preventDefault(); toggleFlag(focusedIdx); }
  if(e.key==='Enter' || e.key===' '){ e.preventDefault(); onCellClick(focusedIdx); }
  if(e.ctrlKey && e.key.toLowerCase()==='r'){ e.preventDefault(); startGameFromUI(); }
  if(e.ctrlKey && e.key.toLowerCase()==='z'){ e.preventDefault(); undo(); }
});
function moveFocus(key){
  const [r,c] = idxToRC(focusedIdx);
  let nr=r, nc=c;
  if(key==='ArrowUp') nr = Math.max(0, r-1);
  if(key==='ArrowDown') nr = Math.min(state.rows-1, r+1);
  if(key==='ArrowLeft') nc = Math.max(0, c-1);
  if(key==='ArrowRight') nc = Math.min(state.cols-1, c+1);
  focusedIdx = rcToIdx(nr,nc);
  const el = UI.boardEl.querySelector(`.cell[data-idx='${focusedIdx}']`);
  if(el) el.focus();
}

/* -------------------- Confetti (simple) -------------------- */
const confettiCanvas = document.getElementById('confettiCanvas');
confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight;
window.addEventListener('resize', ()=> { confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; });
function confettiBurst(){
  const ctx = confettiCanvas.getContext('2d');
  const pieces = [];
  const colors = ['#2b7cff','#ffb400','#ff4d4f','#10b981','#7c3aed'];
  for(let i=0;i<120;i++){
    pieces.push({x:Math.random()*confettiCanvas.width, y:-Math.random()*200, vx:(Math.random()-0.5)*6, vy:Math.random()*6+2, size:Math.random()*8+6, color:colors[Math.floor(Math.random()*colors.length)], rot:Math.random()*360, rotS:Math.random()*8-4, life:200 + Math.random()*300});
  }
  let last = performance.now();
  function frame(ts){
    const dt = ts - last; last = ts;
    ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
    for(let p of pieces){
      p.x += p.vx; p.y += p.vy; p.vy += 0.08; p.rot += p.rotS; p.life -= dt;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180);
      ctx.fillStyle = p.color; ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6);
      ctx.restore();
    }
    if(pieces.some(p=>p.life>0 && p.y < confettiCanvas.height+50)) requestAnimationFrame(frame); else ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
  }
  requestAnimationFrame(frame);
}

/* -------------------- Admin: auth + UI -------------------- */
function openLogin(){ UI.loginModal.classList.add('open'); UI.loginModal.setAttribute('aria-hidden','false'); UI.loginUser.focus(); }
function closeLogin(){ UI.loginModal.classList.remove('open'); UI.loginModal.setAttribute('aria-hidden','true'); UI.loginUser.value=''; UI.loginPass.value=''; }
function openAdmin(){ UI.adminModal.classList.add('open'); UI.adminModal.setAttribute('aria-hidden','false'); renderAudit(); }
function closeAdmin(){ UI.adminModal.classList.remove('open'); UI.adminModal.setAttribute('aria-hidden','true'); }

UI.openAdminBtn.addEventListener('click', ()=>{
  if(isAdmin()){ openAdmin(); return; }
  openLogin();
});
UI.loginCancel.addEventListener('click', closeLogin);
UI.loginSubmit.addEventListener('click', ()=>{
  const u = UI.loginUser.value.trim();
  const p = UI.loginPass.value;
  // demo credentials
  if(u==='Sam' && p==='test'){ setAdminSession('Sam'); closeLogin(); openAdmin(); UI.adminBadge.style.display='inline-block'; UI.adminUserBadge.textContent='Sam'; renderAudit(); }
  else { alert('Invalid credentials'); }
});
UI.adminLogout.addEventListener('click', ()=> { clearAdminSession(); closeAdmin(); });

/* admin actions */
UI.adminApply.addEventListener('click', ()=>{
  const mode = UI.adminMode.value;
  if(mode==='custom'){
    const r = parseInt(UI.adminRows.value||9), c = parseInt(UI.adminCols.value||9), m = parseInt(UI.adminMines.value||10);
    createGrid(r,c,m); renderBoard();
    logAudit('admin_apply_custom', `${r}x${c} m:${m}`);
  } else {
    const map = {beginner:[9,9,10], intermediate:[16,16,40], expert:[16,30,99]};
    const [r,c,m] = map[mode];
    createGrid(r,c,m); renderBoard();
    logAudit('admin_apply_preset', mode);
  }
});
UI.adminStart.addEventListener('click', ()=> { startGameFromUI(); logAudit('admin_start_game',''); });

UI.softRevealToggle.addEventListener('change', (e)=> { if(!isAdmin()){ alert('Admin only'); UI.softRevealToggle.checked = false; return; } setSoftReveal(e.target.checked); });
UI.confettiToggle.addEventListener('change', ()=> logAudit('admin_set_confetti', UI.confettiToggle.checked));
UI.muteToggle.addEventListener('change', ()=> logAudit('admin_set_mute', UI.muteToggle.checked));

UI.adminExportConfig.addEventListener('click', ()=>{
  if(!isAdmin()) return alert('Admin only');
  const cfg = {rows:state.rows, cols:state.cols, mines:state.mines, softReveal:state.softReveal, confetti:UI.confettiToggle.checked, mute:UI.muteToggle.checked};
  const blob = new Blob([JSON.stringify(cfg, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='minesight_admin_config.json'; a.click();
  URL.revokeObjectURL(url);
  logAudit('admin_export_config','');
});
UI.adminImportBtn.addEventListener('click', ()=> UI.adminImportFile.click());
UI.adminImportFile.addEventListener('change', (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ()=> {
    try{
      const cfg = JSON.parse(r.result);
      if(cfg.rows && cfg.cols && cfg.mines){ createGrid(cfg.rows, cfg.cols, cfg.mines); renderBoard(); UI.confettiToggle.checked = !!cfg.confetti; UI.muteToggle.checked = !!cfg.mute; if(cfg.softReveal) UI.softRevealToggle.checked=true; setSoftReveal(!!cfg.softReveal); logAudit('admin_import_config',''); }
      else alert('Invalid config file');
    }catch(e){ alert('Import error'); }
  }; r.readAsText(f);
});

UI.exportLB.addEventListener('click', ()=>{
  const blob = new Blob([localStorage.getItem(CONF.leaderboardKey) || '{}'], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='minesight_leaderboard.json'; a.click();
  URL.revokeObjectURL(url);
  logAudit('admin_export_lb','');
});
UI.clearLBAdmin.addEventListener('click', ()=> { if(confirm('Clear leaderboard?')) { clearLeaderboard(); logAudit('admin_clear_lb',''); }});
UI.simulateBtn.addEventListener('click', ()=> { simulateData(); logAudit('admin_simulate',''); });
UI.forceRevealBtn.addEventListener('click', ()=> { if(confirm('Force reveal mines and lose the game?')){ revealMineForce(); logAudit('admin_force_reveal',''); }});
UI.resetAuditBtn.addEventListener('click', ()=> { if(confirm('Clear audit log?')) { localStorage.removeItem(CONF.auditKey); renderAudit(); logAudit('admin_clear_audit',''); }});
UI.closeAdmin.addEventListener('click', closeAdmin);

/* -------------------- Other UI wiring -------------------- */
UI.modeSelect.addEventListener('change', ()=>{
  UI.customControls.style.display = UI.modeSelect.value==='custom' ? 'block' : 'none';
});
UI.startBtn.addEventListener('click', startGameFromUI);
UI.newGameTop.addEventListener('click', startGameFromUI);
UI.showMinesButton.addEventListener('click', ()=>{
  if(!isAdmin()){ openLogin(); return; }
  const enabled = !state.softReveal;
  UI.softRevealToggle.checked = enabled;
  setSoftReveal(enabled);
});
UI.hintBtn.addEventListener('click', useHint);
UI.copyResult.addEventListener('click', copyResult);
UI.resetHints.addEventListener('click', ()=> { state.hintCount = CONF.defaultHints; updateBoardVisuals(); logAudit('admin_reset_hints',''); });
UI.clearLBBtn.addEventListener('click', ()=> { if(confirm('Clear leaderboard?')) clearLeaderboard(); });
UI.undoBtn.addEventListener('click', ()=> undo());
UI.themeSelect.addEventListener('change', ()=> { document.documentElement.setAttribute('data-theme', UI.themeSelect.value==='dark' ? 'dark' : 'light'); });

/* -------------------- Simulate data (admin-only helper) -------------------- */
function simulateData(){
  if(!isAdmin()) return alert('Admin only');
  const mode = UI.modeSelect.value;
  for(let i=0;i<6;i++){
    addLeaderboardEntry(mode, `SimUser${Math.floor(Math.random()*999)}`, Math.floor(Math.random()*300)+10);
  }
}

/* -------------------- Force reveal (admin-only) - lose -------------------- */
function revealMineForce(){
  for(let i=0;i<state.grid.length;i++) if(state.grid[i].mine) state.grid[i].revealed = true;
  state.gameOver = true; stopTimer(); updateBoardVisuals(); UI.statusText.textContent='Admin forced reveal â€” lost';
}

/* -------------------- Start logic from UI -------------------- */
function startGameFromUI(){
  const m = UI.modeSelect.value;
  if(m==='custom'){
    const r = Math.max(5, Math.min(80, parseInt(UI.rowsInput.value || 9)));
    const c = Math.max(5, Math.min(120, parseInt(UI.colsInput.value || 9)));
    const mines = Math.max(1, Math.min(r*c-1, parseInt(UI.minesInput.value || 10)));
    createGrid(r,c,mines);
  } else {
    const map = {beginner:[9,9,10], intermediate:[16,16,40], expert:[16,30,99]};
    const [r,c,mines] = map[m];
    createGrid(r,c,mines);
  }
  state.compact = UI.compactToggle.checked;
  state.autoOpen = UI.autoOpenChk.checked;
  renderBoard();
  UI.statusText.textContent = 'Ready';
  renderLeaderboard();
  logAudit('game_start', `${state.rows}x${state.cols} mines:${state.mines}`);
}

/* -------------------- Export / Import helpers (used above) -------------------- */
/* implemented inline in admin handlers */

/* -------------------- Initialization -------------------- */
(function init(){
  UI.modeSelect.value = 'beginner';
  createGrid(9,9,10);
  renderBoard();
  renderLeaderboard();
  renderAudit();
  // restore admin session if exists
  const session = sessionStorage.getItem(CONF.adminSessionKey);
  if(session){ UI.adminBadge.style.display='inline-block'; UI.adminUserBadge.textContent = JSON.parse(session).user; }
  // accessibility: focus first cell on board click
  UI.boardEl.addEventListener('click', ()=> { const first = UI.boardEl.querySelector('.cell'); if(first) { first.focus(); focusedIdx = parseInt(first.getAttribute('data-idx')); }});
})();
function renderAudit(){ if(UI.auditLogEl) { const raw=localStorage.getItem(CONF.auditKey); UI.auditLogEl.innerHTML = ''; (raw?JSON.parse(raw):[]).slice(0,200).forEach(a=>{ const d=document.createElement('div'); d.style.padding='6px'; d.style.borderBottom='1px solid rgba(0,0,0,0.04)'; d.style.fontSize='13px'; d.style.color='var(--muted)'; d.textContent=`${a.ts} â€” ${a.action} ${a.detail ? ' â€” ' + a.detail : ''}`; UI.auditLogEl.appendChild(d); }); }}

/* -------------------- Helpers -------------------- */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }
function rcToIdx(r,c){ return r*state.cols + c; }

/* -------------------- End of script -------------------- */
</script>
</body>
</html>
