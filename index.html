<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Minesight Pro â€” Admin Operator Edition (All Abuses)</title>
<meta name="description" content="Minesight Pro with a full admin control center and dozens of admin features." />
<style>
  :root{
    --bg:linear-gradient(180deg,#f5f9ff,#eef6ff);
    --card:#fff; --muted:#6b7280; --text:#061025; --accent:#2563eb;
    --cell:#eef6ff; --cell-border:#cddaf2; --danger:#ff4d4f; --flag:#ffb400;
  }
  [data-theme="dark"]{
    --bg:linear-gradient(180deg,#071026,#08142a);
    --card:#071428; --muted:#9aa7bf; --text:#e6eef6; --accent:#60a5fa;
    --cell:#0b1220; --cell-border:#1f2937; --danger:#ff6b6b; --flag:#ffc870;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:var(--bg); color:var(--text); display:flex; align-items:center; justify-content:center; padding:24px;}
  main{width:100%;max-width:1250px; display:grid; grid-template-columns:380px 1fr; gap:18px; align-items:start;}
  .panel{background:var(--card); border-radius:12px; padding:14px; box-shadow:0 10px 30px rgba(2,6,23,0.06); border:1px solid rgba(0,0,0,0.04);}
  header{grid-column:1/-1; display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:6px;}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:48px;height:48px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(180deg,var(--accent), color-mix(in srgb,var(--accent) 60%, black));color:#fff;font-weight:900}
  h1{margin:0;font-size:18px}
  .meta{color:var(--muted);font-size:13px}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  .btn.primary{background:linear-gradient(180deg,var(--accent), color-mix(in srgb,var(--accent) 70%, black));color:#fff}
  .btn.ghost{background:transparent;border:1px solid var(--cell-border)}
  .controls{display:flex;flex-direction:column;gap:10px}
  label{font-size:13px;color:var(--muted)}
  select,input[type=number],input[type=text]{padding:8px;border-radius:8px;border:1px solid var(--cell-border);background:var(--cell);color:var(--text);width:100%}
  .stats{display:flex;gap:8px}
  .stat{background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(255,255,255,0.02));padding:8px;border-radius:8px;min-width:92px;text-align:center;font-weight:800;border:1px solid var(--cell-border)}
  .board-shell{display:flex;flex-direction:column;gap:12px;align-items:center}
  .topbar{width:100%;display:flex;justify-content:space-between;align-items:center;gap:12px}
  .pill{background:rgba(255,255,255,0.6);padding:6px 12px;border-radius:10px;font-weight:800}
  .board-wrap{padding:12px;min-height:360px;display:flex;align-items:center;justify-content:center}
  .board{display:grid;gap:6px}
  .cell{width:38px;aspect-ratio:1/1;border-radius:8px;background:var(--cell);border:1px solid var(--cell-border);display:grid;place-items:center;font-weight:800;cursor:pointer;user-select:none}
  .cell.revealed{background:linear-gradient(180deg,#f8fafc,#eef3ff);cursor:default}
  .cell.flag{color:var(--flag)}
  .cell.mine{color:var(--danger)}
  .soft-mine::after{content:"ðŸ’£";position:absolute;font-size:16px;pointer-events:none}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:1200}
  .modal.open{display:flex}
  .card-lg{width:880px;max-width:96%;padding:14px;border-radius:12px;background:var(--card);box-shadow:0 20px 60px rgba(3,6,23,0.35)}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .audit{max-height:260px;overflow:auto;padding:8px;border-radius:8px;border:1px solid var(--cell-border);background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(255,255,255,0.02));font-size:13px;color:var(--muted)}
  .danger{background:linear-gradient(180deg,#fff2f2,#ffecec);border:1px solid rgba(255,77,79,0.12);color:var(--danger);padding:8px;border-radius:8px;font-weight:800}
  @media (max-width:1000px){main{grid-template-columns:1fr} .cell{width:34px}}
</style>
</head>
<body>
<main>
  <header class="panel">
    <div class="brand">
      <div class="logo">MP</div>
      <div>
        <h1>Minesight Pro â€” Admin Operator Edition</h1>
        <div class="meta">Full admin abuse toolkit â€¢ Audit logging â€¢ Single-file demo</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <select id="themeSel"><option value="light">Light</option><option value="dark">Dark</option></select>
      <button id="newBtn" class="btn primary">New Game</button>
      <button id="openAdmin" class="btn ghost">Admin Panel</button>
      <div id="adminBadge" style="display:none;padding:8px;border-radius:8px;background:linear-gradient(180deg,#eef6ff,#f8fbff);border:1px solid var(--cell-border);font-weight:800;color:var(--muted)">ADMIN</div>
    </div>
  </header>

  <!-- left controls -->
  <section class="panel controls" aria-label="Controls">
    <label>Mode</label>
    <select id="mode"><option value="beginner">Beginner â€” 9Ã—9 Â· 10</option><option value="intermediate">Intermediate â€” 16Ã—16 Â· 40</option><option value="expert">Expert â€” 16Ã—30 Â· 99</option><option value="custom">Custom</option></select>
    <div id="customDiv" style="display:none">
      <label>Rows Â· Cols Â· Mines</label>
      <div style="display:flex;gap:8px">
        <input id="rows" type="number" min="5" max="80" value="9">
        <input id="cols" type="number" min="5" max="120" value="9">
        <input id="mines" type="number" min="1" max="1000" value="10">
      </div>
    </div>

    <div class="stats" style="margin-top:8px">
      <div class="stat" id="mineCt">Mines: 10</div>
      <div class="stat" id="flagCt">Flags: 0</div>
      <div class="stat" id="timer">Time: 0s</div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px">
      <button id="start" class="btn primary">Start</button>
      <button id="hint" class="btn ghost">Hint</button>
    </div>

    <div style="margin-top:12px">
      <label>Options</label>
      <div style="display:flex;flex-direction:column;gap:6px">
        <label><input id="autoOpen" type="checkbox" checked> Auto-open (chording)</label>
        <label><input id="sounds" type="checkbox" checked> Sounds</label>
        <label><input id="compact" type="checkbox"> Compact board</label>
      </div>
    </div>

    <div style="margin-top:12px">
      <label>Leaderboard</label>
      <div id="leaderboard" style="min-height:80px;display:flex;flex-direction:column;gap:6px"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="player" placeholder="Player name">
        <button id="submitScore" class="btn ghost">Submit</button>
        <button id="clearLB" class="btn ghost">Clear</button>
      </div>
    </div>
  </section>

  <!-- right board -->
  <section class="panel board-shell" aria-label="Board">
    <div class="topbar">
      <div class="status">
        <div class="pill" id="status">Ready</div>
        <div class="pill" id="info">9 Ã— 9 Â· Beginner</div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="softShowBtn" class="btn ghost">Soft-Show Mines</button>
        <button id="copy" class="btn ghost">Copy Result</button>
        <button id="resetHints" class="btn ghost">Reset Hints</button>
      </div>
    </div>

    <div class="board-wrap">
      <div id="board" class="board" role="grid" tabindex="0"></div>
    </div>

    <div style="display:flex;justify-content:space-between;margin-top:8px">
      <div style="display:flex;gap:8px">
        <button id="undo" class="btn ghost">Undo</button>
        <button id="toggleCompact" class="btn ghost">Toggle Compact</button>
      </div>
      <div style="font-size:13px;color:var(--muted)">Minesight Pro â€¢ Admin v3.0</div>
    </div>
  </section>
</main>

<!-- Login modal -->
<div id="loginModal" class="modal" aria-hidden="true">
  <div class="card-lg">
    <h2 style="margin:0">Administrator Login</h2>
    <p style="color:var(--muted)">Enter administrator credentials (hidden from UI).</p>
    <div style="display:flex;gap:8px;margin-top:12px">
      <input id="loginUser" placeholder="Username" />
      <input id="loginPass" placeholder="Password" type="password" />
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="cancelLogin" class="btn ghost">Cancel</button>
      <button id="submitLogin" class="btn primary">Sign in</button>
    </div>
  </div>
</div>

<!-- Admin panel -->
<div id="adminModal" class="modal" aria-hidden="true">
  <div class="card-lg" role="dialog" aria-modal="true">
    <header style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h2 style="margin:0">Admin Control Center</h2>
        <div style="color:var(--muted)">Powerful operator tools â€” actions are audited.</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="adminName" style="font-weight:800;color:var(--muted)"></div>
        <button id="adminLogoutBtn" class="btn ghost">Logout</button>
      </div>
    </header>

    <div style="margin-top:12px" class="grid-2">
      <!-- left column: quick controls + abuses -->
      <div>
        <h3 style="margin:6px 0">Quick controls</h3>
        <label>Mode</label>
        <select id="adminMode"><option value="beginner">Beginner</option><option value="intermediate">Intermediate</option><option value="expert">Expert</option><option value="custom">Custom</option></select>

        <div id="adminCustom" style="display:none;margin-top:8px">
          <label>Rows / Cols / Mines</label>
          <div style="display:flex;gap:8px">
            <input id="adminRows" type="number" min="5" max="80" value="9">
            <input id="adminCols" type="number" min="5" max="120" value="9">
            <input id="adminMines" type="number" min="1" max="1000" value="10">
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="adminApply" class="btn primary">Apply</button>
          <button id="adminStart" class="btn ghost">Start</button>
        </div>

        <hr style="margin:12px 0">

        <h3 style="margin:6px 0">Visibility & Hacks (abuse toolkit)</h3>

        <!-- We'll list 30+ toggles / actions here -->
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px">
          <label style="width:48%"><input type="checkbox" id="adminSoftReveal"> Soft-reveal (visual only)</label>
          <label style="width:48%"><input type="checkbox" id="adminInvincible"> Invincible (click mines ok)</label>
          <label style="width:48%"><input type="checkbox" id="adminLockBoard"> Lock board (disable user)</label>
          <label style="width:48%"><input type="checkbox" id="adminAutoFlag"> Auto-flag mines</label>
          <label style="width:48%"><input type="checkbox" id="adminHighlight"> Highlight danger pattern</label>
          <label style="width:48%"><input type="checkbox" id="adminShowSafePath"> Show safe path</label>
          <label style="width:48%"><input type="checkbox" id="adminNoHints"> Disable hints for users</label>
          <label style="width:48%"><input type="checkbox" id="adminBlockInput"> Block keyboard controls</label>
          <label style="width:48%"><input type="checkbox" id="adminGhostMode"> Ghost reveal (reveal then hide)</label>
          <label style="width:48%"><input type="checkbox" id="adminStepMode"> Step reveal mode</label>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button id="forceWin" class="btn ghost">Force Win</button>
          <button id="forceLose" class="btn ghost">Force Lose</button>
          <button id="massFlagBtn" class="btn ghost">Mass Flag</button>
          <button id="massUnflagBtn" class="btn ghost">Mass Unflag</button>
          <button id="autoSolveBtn" class="btn ghost">Auto-Solve</button>
          <button id="stepRevealBtn" class="btn ghost">Step Reveal Next</button>
        </div>

        <hr style="margin:12px 0">

        <h3 style="margin:6px 0">Timer & state abuses</h3>
        <div style="display:flex;gap:8px">
          <button id="freezeTimerBtn" class="btn ghost">Freeze</button>
          <button id="warpTimeBtn" class="btn ghost">Warp +60s</button>
          <button id="setTimerBtn" class="btn ghost">Set Time...</button>
        </div>

        <div style="margin-top:8px">
          <button id="snapshotExport" class="btn ghost">Export Snapshot</button>
          <input id="snapshotImport" type="file" accept="application/json" style="display:none">
          <button id="snapshotLoadBtn" class="btn ghost">Load Snapshot</button>
        </div>

      </div>

      <!-- right column: leaderboards, manual design, audit, destructive -->
      <div>
        <h3 style="margin:6px 0">Leaderboard & Users</h3>
        <div style="display:flex;gap:8px">
          <input id="lbName" placeholder="Name" />
          <input id="lbTime" placeholder="Time (s)" type="number" />
          <button id="lbAdd" class="btn ghost">Add</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="exportLB" class="btn ghost">Export LB</button>
          <button id="clearLBAdmin" class="btn ghost">Clear LB</button>
          <button id="spamLB" class="btn ghost">Spam LB (scale)</button>
        </div>

        <hr style="margin:12px 0">

        <h3 style="margin:6px 0">Board Designer & Seeds</h3>
        <label>Manual mine indices (comma list)</label>
        <input id="manualIndices" placeholder="e.g. 0,5,12" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="applyManualBtn" class="btn ghost">Apply</button>
          <input id="seedInput" placeholder="seed (number/string)" />
          <button id="applySeed" class="btn ghost">Apply Seed</button>
        </div>

        <hr style="margin:12px 0">

        <h3 style="margin:6px 0">Audit log</h3>
        <div id="audit" class="audit"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="exportAudit" class="btn ghost">Export Audit</button>
          <button id="clearAudit" class="btn ghost danger">Clear Audit</button>
        </div>

        <hr style="margin:12px 0">

        <h3 style="margin:6px 0">Danger zone</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="clearAll" class="btn danger">Clear LB + Audit</button>
          <button id="resetAll" class="btn danger">Reset Everything</button>
          <button id="nukeBoard" class="btn danger">Nuke Board (new random)</button>
        </div>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px">
      <button id="closeAdmin" class="btn ghost">Close</button>
    </div>
  </div>
</div>

<!-- confetti canvas -->
<canvas id="confetti" style="position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:9999"></canvas>

<script>
/* Minesight Pro â€” Full implementation with 30+ admin abuses
   Demo admin credentials are intentionally not shown in UI.
   For demo only: username 'Sam', password 'test' (kept in code).
*/

/* -------------------- Hidden credentials (not displayed) -------------------- */
const _ADMIN_CREDS = { user: 'Sam', pass: 'test' }; // hidden from interface

/* -------------------- Utility & DOM refs -------------------- */
const refs = {
  board: document.getElementById('board'), mode: document.getElementById('mode'), rows: document.getElementById('rows'),
  cols: document.getElementById('cols'), mines: document.getElementById('mines'), startBtn: document.getElementById('start'),
  hintBtn: document.getElementById('hint'), mineCt: document.getElementById('mineCt'), flagCt: document.getElementById('flagCt'),
  timerEl: document.getElementById('timer'), status: document.getElementById('status'), info: document.getElementById('info'),
  leaderboard: document.getElementById('leaderboard'), player: document.getElementById('player'), submitScore: document.getElementById('submitScore'),
  clearLB: document.getElementById('clearLB'), openAdmin: document.getElementById('openAdmin'), loginModal: document.getElementById('loginModal'),
  loginUser: document.getElementById('loginUser'), loginPass: document.getElementById('loginPass'), submitLogin: document.getElementById('submitLogin'),
  cancelLogin: document.getElementById('cancelLogin'), adminModal: document.getElementById('adminModal'), adminName: document.getElementById('adminName'),
  adminLogoutBtn: document.getElementById('adminLogoutBtn'), adminMode: document.getElementById('adminMode'), adminApply: document.getElementById('adminApply'),
  adminStart: document.getElementById('adminStart'), adminCustom: document.getElementById('adminCustom'), adminRows: document.getElementById('adminRows'),
  adminCols: document.getElementById('adminCols'), adminMines: document.getElementById('adminMines'), adminSoftReveal: document.getElementById('adminSoftReveal'),
  adminInvincible: document.getElementById('adminInvincible'), adminLockBoard: document.getElementById('adminLockBoard'), adminAutoFlag: document.getElementById('adminAutoFlag'),
  adminHighlight: document.getElementById('adminHighlight'), adminShowSafePath: document.getElementById('adminShowSafePath'),
  adminNoHints: document.getElementById('adminNoHints'), adminBlockInput: document.getElementById('adminBlockInput'),
  adminGhostMode: document.getElementById('adminGhostMode'), adminStepMode: document.getElementById('adminStepMode'),
  forceWin: document.getElementById('forceWin'), forceLose: document.getElementById('forceLose'), massFlagBtn: document.getElementById('massFlagBtn'),
  massUnflagBtn: document.getElementById('massUnflagBtn'), autoSolveBtn: document.getElementById('autoSolveBtn'), stepRevealBtn: document.getElementById('stepRevealBtn'),
  freezeTimerBtn: document.getElementById('freezeTimerBtn'), warpTimeBtn: document.getElementById('warpTimeBtn'), setTimerBtn: document.getElementById('setTimerBtn'),
  snapshotExport: document.getElementById('snapshotExport'), snapshotImport: document.getElementById('snapshotImport'), snapshotLoadBtn: document.getElementById('snapshotLoadBtn'),
  lbName: document.getElementById('lbName'), lbTime: document.getElementById('lbTime'), lbAdd: document.getElementById('lbAdd'),
  exportLB: document.getElementById('exportLB'), clearLBAdmin: document.getElementById('clearLBAdmin'), spamLB: document.getElementById('spamLB'),
  manualIndices: document.getElementById('manualIndices'), applyManualBtn: document.getElementById('applyManualBtn'), seedInput: document.getElementById('seedInput'),
  applySeed: document.getElementById('applySeed'), audit: document.getElementById('audit'), exportAudit: document.getElementById('exportAudit'),
  clearAudit: document.getElementById('clearAudit'), clearAll: document.getElementById('clearAll'), resetAll: document.getElementById('resetAll'), nukeBoard: document.getElementById('nukeBoard'),
  softShowBtn: document.getElementById('softShowBtn'), themeSel: document.getElementById('themeSel'), newBtn: document.getElementById('newBtn'),
  undoBtn: document.getElementById('undo'), toggleCompact: document.getElementById('toggleCompact'), compactCheck: document.getElementById('compact'),
  autoOpenChk: document.getElementById('autoOpen'), soundsChk: document.getElementById('sounds'), copyBtn: document.getElementById('copy'),
  resetHints: document.getElementById('resetHints')
};

/* -------------------- Constants & Storage keys -------------------- */
const KEYS = {
  LB: 'minesight_pro_lb_v2',
  AUDIT: 'minesight_pro_audit_v2',
  ADMIN: 'minesight_pro_admin_session_v2'
};

/* -------------------- Game state -------------------- */
let state = {
  rows:9, cols:9, mines:10,
  grid: [], // {mine,revealed,flagged,num}
  started:false, startTs:0, elapsed:0, timerId:null,
  flagsLeft:10, revealed:0, gameOver:false, won:false,
  hintCount:3, compact:false, autoOpen:true, sounds:true,
  softReveal:false, invincible:false, locked:false, ghostMode:false, stepMode:false, blockInput:false
};

/* audit log helper */
function audit(action, detail=''){ const arr = JSON.parse(localStorage.getItem(KEYS.AUDIT) || '[]'); arr.unshift({ts:new Date().toISOString(), action, detail}); localStorage.setItem(KEYS.AUDIT, JSON.stringify(arr.slice(0,2000))); renderAudit(); }

/* -------------------- Helper fns -------------------- */
function idx(r,c){ return r*state.cols + c; }
function rc(i){ return [Math.floor(i/state.cols), i%state.cols]; }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

/* -------------------- Create & render board -------------------- */
function createGrid(r,c,m,seed=null,manualIndices=null){
  state.rows=r; state.cols=c; state.mines=m;
  state.grid = Array.from({length:r*c}, ()=>({mine:false,revealed:false,flagged:false,num:0}));
  // seed or random; if seed provided, use simple seeded RNG (xorshift)
  let indices = [...Array(r*c).keys()];
  if(manualIndices && manualIndices.length) {
    // set manual mines only; others random
    indices = indices.filter(i => !manualIndices.includes(i));
    manualIndices.forEach(i => state.grid[i].mine=true);
    const remaining = indices.slice();
    shuffle(remaining);
    let need = Math.max(0, m - manualIndices.length);
    for(let i=0;i<need;i++){ state.grid[remaining[i]].mine=true; }
  } else if(seed !== null && seed !== undefined && seed !== ''){
    let s = 0;
    for(let ch of String(seed)) s = ((s<<5)-s)+ch.charCodeAt(0);
    function rng(){ s ^= s<<13; s ^= s>>>17; s ^= s<<5; return Math.abs(s) % (r*c); }
    let placed=0;
    const used = new Set();
    while(placed < m){
      const p = rng();
      if(used.has(p)) continue;
      used.add(p); state.grid[p].mine = true; placed++;
    }
  } else {
    shuffle(indices);
    for(let i=0;i<m;i++) state.grid[indices[i]].mine=true;
  }
  // compute numbers
  for(let i=0;i<state.grid.length;i++){
    if(state.grid[i].mine) continue;
    const [rr,cc] = rc(i);
    let cnt=0;
    for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
      if(dr===0 && dc===0) continue;
      const nr=rr+dr, nc=cc+dc;
      if(nr>=0 && nr<r && nc>=0 && nc<c) if(state.grid[idx(nr,nc)].mine) cnt++;
    }
    state.grid[i].num = cnt;
  }
  // reset play state
  state.started=false; stopTimer(); state.elapsed=0; state.revealed=0; state.flagsLeft=m; state.gameOver=false; state.won=false;
  state.hintCount = 3;
  renderBoard(); updateStats();
  audit('create_grid', `${r}x${c},mines:${m},seed:${seed?seed:'none'}`);
}

function renderBoard(){
  refs.board.innerHTML='';
  refs.board.style.gridTemplateColumns = `repeat(${state.cols}, ${state.compact? '32px' : '38px'})`;
  refs.board.style.gap = state.compact? '4px' : '6px';
  for(let i=0;i<state.grid.length;i++){
    const cell = document.createElement('button');
    cell.className='cell';
    cell.style.position='relative';
    cell.dataset.idx = i;
    if(state.grid[i].revealed){
      cell.classList.add('revealed');
      if(state.grid[i].mine){ cell.classList.add('mine'); cell.textContent='ðŸ’£'; }
      else if(state.grid[i].num>0){ cell.textContent = state.grid[i].num; }
    } else {
      if(state.grid[i].flagged){ cell.classList.add('flag'); cell.textContent='âš‘'; }
      if(state.softReveal && state.grid[i].mine && isAdmin()) cell.classList.add('soft-mine');
    }
    // events (blocked if admin locked or blockInput)
    cell.addEventListener('click', (e)=> { if(state.locked || state.blockInput) return; onCellClick(i); });
    cell.addEventListener('contextmenu', (e)=> { e.preventDefault(); if(state.locked || state.blockInput) return; toggleFlag(i); });
    cell.addEventListener('keydown', (e)=> { if(state.blockInput) return; if(e.key==='Enter' || e.key===' ') { e.preventDefault(); onCellClick(i);} if(e.key.toLowerCase()==='f'){ e.preventDefault(); toggleFlag(i);} });
    refs.board.appendChild(cell);
  }
  refs.info.textContent = `${state.rows} Ã— ${state.cols} Â· ${refs.mode.value.split('â€”')[0].trim()}`;
}

/* -------------------- Interactions -------------------- */
function onCellClick(i){
  if(state.gameOver) return;
  const cell = state.grid[i];
  if(cell.revealed){
    if(state.autoOpen && refs.autoOpen.checked) chord(i);
    return;
  }
  if(cell.flagged) return;
  if(!state.started){ state.started=true; startTimer(); }
  if(cell.mine){
    if(state.invincible) { // do visual but not lose
      // reveal and mark briefly (ghost mode)
      cell.revealed = true; renderBoard();
      setTimeout(()=>{ if(!state.invincible){ cell.revealed=false; renderBoard(); } else { cell.revealed=false; renderBoard(); } }, 800);
      audit('invincible_click', `idx:${i}`);
      return;
    }
    revealAllMines(i); endGame(false); return;
  }
  floodReveal(i);
  updateStats(); checkWin();
}

function toggleFlag(i){
  if(state.gameOver) return;
  const c = state.grid[i];
  if(c.revealed) return;
  c.flagged = !c.flagged;
  state.flagsLeft += c.flagged? -1 : 1;
  audit('flag_toggle', `idx:${i} flag:${c.flagged}`);
  renderBoard(); updateStats(); checkWin();
}

function chord(i){
  const cell = state.grid[i];
  if(!cell.revealed || cell.num === 0) return;
  const [r,c] = rc(i);
  let flagged=0, toReveal=[];
  for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
    if(dr===0 && dc===0) continue;
    const nr=r+dr, nc=c+dc;
    if(nr>=0 && nr<state.rows && nc>=0 && nc<state.cols){
      const idx0 = idx(nr,nc);
      if(state.grid[idx0].flagged) flagged++;
      else if(!state.grid[idx0].revealed) toReveal.push(idx0);
    }
  }
  if(flagged === cell.num){
    for(const t of toReveal){
      if(state.grid[t].mine){ revealAllMines(t); endGame(false); return; }
      floodReveal(t);
    }
    renderBoard();
  }
}

/* flood reveal BFS */
function floodReveal(start){
  const q=[start], seen=new Set();
  while(q.length){
    const cur = q.shift();
    if(seen.has(cur)) continue;
    const c = state.grid[cur];
    if(c.revealed || c.flagged) continue;
    c.revealed = true; seen.add(cur); state.revealed++;
    if(c.num===0 && !c.mine){
      const [r,cc] = rc(cur);
      for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
        if(dr===0 && dc===0) continue;
        const nr=r+dr, nc=cc+dc;
        if(nr>=0 && nr<state.rows && nc>=0 && nc<state.cols) q.push(idx(nr,nc));
      }
    }
  }
  renderBoard();
}

/* reveal all mines (losing reveal) */
function revealAllMines(clicked){
  for(let i=0;i<state.grid.length;i++) if(state.grid[i].mine) state.grid[i].revealed = true;
  state.gameOver = true; stopTimer(); renderBoard();
  audit('reveal_all_mines', `clicked:${clicked}`);
}

/* -------------------- Timer management -------------------- */
function startTimer(){ if(state.timerId) return; state.startTs = Date.now()-state.elapsed*1000; state.timerId = setInterval(()=>{ state.elapsed = Math.floor((Date.now()-state.startTs)/1000); refs.timerEl.textContent = `Time: ${state.elapsed}s`; }, 500); }
function stopTimer(){ if(state.timerId){ clearInterval(state.timerId); state.timerId=null; } }
function setTimerValue(s){ state.elapsed = s; refs.timerEl.textContent = `Time: ${state.elapsed}s`; if(state.started) { state.startTs = Date.now()-s*1000; } audit('set_timer', s); }

/* -------------------- Win/Lose & stats -------------------- */
function checkWin(){
  const total = state.rows * state.cols;
  if(state.revealed === total - state.mines){
    endGame(true);
  }
}
function endGame(win){
  state.gameOver = true; state.won = win; stopTimer();
  refs.status.textContent = win? `You win! ${state.elapsed}s` : 'Boom! You lost';
  if(win) audit('game_win', `${state.elapsed}s`);
  else audit('game_lost','');
  renderBoard();
}

/* -------------------- Update UI stats -------------------- */
function updateStats(){ refs.mineCt.textContent = `Mines: ${state.mines}`; refs.flagCt.textContent = `Flags: ${Math.max(0, state.mines - state.flagsLeft)}`; refs.timerEl.textContent = `Time: ${state.elapsed}s`; }

/* -------------------- Leaderboard handling -------------------- */
function loadLB(){ try{return JSON.parse(localStorage.getItem(KEYS.LB)||'{}')}catch(e){return{}} }
function saveLB(lb){ localStorage.setItem(KEYS.LB, JSON.stringify(lb)); }
function addLB(mode,name,time){ const lb = loadLB(); if(!lb[mode]) lb[mode]=[]; lb[mode].push({name,time,ts:new Date().toISOString()}); lb[mode].sort((a,b)=>a.time-b.time); lb[mode]=lb[mode].slice(0,200); saveLB(lb); renderLB(); audit('lb_add', `${name}:${time}s`); }
function renderLB(){ const mode = refs.mode.value; const lb = loadLB()[mode]||[]; refs.leaderboard.innerHTML=''; if(lb.length===0){ refs.leaderboard.textContent='No times yet'; return;} lb.slice(0,10).forEach((e,i)=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='6px'; row.style.borderRadius='6px'; row.style.background='linear-gradient(180deg, rgba(0,0,0,0.02), rgba(255,255,255,0.02))'; row.innerHTML=`<div>${i+1}. ${escapeHtml(e.name)}</div><div style="font-weight:800">${e.time}s</div>`; refs.leaderboard.appendChild(row);}); }
function clearLB(){ localStorage.removeItem(KEYS.LB); renderLB(); audit('lb_clear',''); }

/* -------------------- Audit render -------------------- */
function renderAudit(){ const arr = JSON.parse(localStorage.getItem(KEYS.AUDIT)||'[]'); refs.audit.innerHTML=''; if(arr.length===0){ refs.audit.textContent='No admin actions yet'; return;} arr.slice(0,200).forEach(a=>{ const d = document.createElement('div'); d.style.padding='6px'; d.style.borderBottom='1px solid rgba(0,0,0,0.04)'; d.style.fontSize='13px'; d.style.color='var(--muted)'; d.textContent = `${a.ts} â€” ${a.action}${a.detail?(' â€” '+a.detail):''}`; refs.audit.appendChild(d); }); }

/* -------------------- Admin session helpers -------------------- */
function isAdmin(){ return !!sessionStorage.getItem(KEYS.ADMIN); }
function setAdmin(user){ sessionStorage.setItem(KEYS.ADMIN, JSON.stringify({user,ts:new Date().toISOString()})); refs.adminBadge.style.display='inline-block'; refs.adminName.textContent = user; audit('admin_login', user); }
function clearAdmin(){ sessionStorage.removeItem(KEYS.ADMIN); refs.adminBadge.style.display='none'; refs.adminName.textContent=''; audit('admin_logout',''); }

/* -------------------- Admin actions (30+ abuses) -------------------- */

/* 1) Soft reveal: visual only (non-destructive) */
function adminToggleSoftReveal(enabled){ state.softReveal = enabled; renderBoard(); audit('admin_soft_reveal', enabled); }

/* 2) Invincible: clicking a mine won't lose */
function adminSetInvincible(enabled){ state.invincible = enabled; audit('admin_invincible', enabled); }

/* 3) Lock board: disable player input */
function adminLockBoard(enabled){ state.locked = enabled; audit('admin_lock', enabled); }

/* 4) Auto-flag: mark mines with flags (visual) */
function adminAutoFlag(enabled){ if(enabled){ for(let i=0;i<state.grid.length;i++) if(state.grid[i].mine) state.grid[i].flagged = true; state.flagsLeft = 0; } else { for(let i=0;i<state.grid.length;i++) state.grid[i].flagged = false; state.flagsLeft = state.mines; } renderBoard(); audit('admin_auto_flag', enabled); }

/* 5) Highlight: add CSS class to likely danger areas (visual) */
function adminHighlightAreas(enabled){
  // Simple heuristic: mark cells with num>=4 as danger with CSS border (we'll inline)
  const nodes = refs.board.querySelectorAll('.cell');
  nodes.forEach(nd => nd.style.outline='');
  if(enabled){ nodes.forEach(nd => { const i = +nd.dataset.idx; if(state.grid[i].num>=4) nd.style.outline='2px solid rgba(255,77,79,0.18)'; }); }
  audit('admin_highlight', enabled);
}

/* 6) Show safe path: naive BFS from top-left avoiding mines (visual overlay) */
function adminShowSafePath(enabled){
  // compute path using BFS from (0,0) to nearest unrevealed safe cell not mined
  if(!enabled){ renderBoard(); audit('admin_safe_path_off',''); return; }
  const start = 0;
  const q=[start], prev = Array(state.grid.length).fill(-1), seen = new Set([start]);
  while(q.length){
    const cur = q.shift();
    if(!state.grid[cur].mine && !state.grid[cur].revealed){ // show path
      // backtrack path
      let p = cur; while(p!==-1){ const nd = refs.board.querySelector(`.cell[data-idx='${p}']`); if(nd) nd.style.boxShadow='0 0 0 3px rgba(16,185,129,0.14)'; p = prev[p]; }
      audit('admin_safe_path','shown'); return;
    }
    const [r,c0] = rc(cur);
    for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
      const nr=r+dr, nc=c0+dc; if(nr<0||nc<0||nr>=state.rows||nc>=state.cols) continue;
      const ni = idx(nr,nc); if(seen.has(ni)) continue; seen.add(ni); prev[ni]=cur; q.push(ni);
    }
  }
  audit('admin_safe_path','none_found');
}

/* 7) Disable hints */
function adminDisableHints(enabled){ state.hintCount = enabled?0:3; audit('admin_disable_hints', enabled); updateStats(); }

/* 8) Block keyboard input */
function adminBlockInput(enabled){ state.blockInput = enabled; audit('admin_block_input', enabled); }

/* 9) Ghost mode: reveal then hide squares quickly (demo) */
function adminGhostReveal(enabled){
  if(!enabled){ renderBoard(); audit('admin_ghost_off',''); return; }
  // reveal random safe cells briefly
  for(let i=0;i<5;i++){
    const idxs = [...Array(state.grid.length).keys()].filter(x=>!state.grid[x].mine && !state.grid[x].revealed);
    shuffle(idxs);
    const p = idxs[0];
    if(!p && p!==0) continue;
    state.grid[p].revealed = true; renderBoard();
    setTimeout(()=>{ state.grid[p].revealed=false; renderBoard(); }, 500 + i*200);
  }
  audit('admin_ghost_reveal','triggered');
}

/* 10) Step reveal mode (admin steps reveal one cell at a time) */
function adminStepRevealNext(){
  // find next unrevealed safe cell and reveal it
  const idxs = [...Array(state.grid.length).keys()].filter(i=>!state.grid[i].revealed && !state.grid[i].mine);
  if(idxs.length===0) return; const p = idxs[0]; floodReveal(p); audit('admin_step_reveal', p); renderBoard();
}

/* 11) Force Win */
function adminForceWin(){ // mark all non-mines revealed and call win
  for(let i=0;i<state.grid.length;i++) if(!state.grid[i].mine) state.grid[i].revealed = true;
  state.revealed = state.rows*state.cols - state.mines; endGame(true); audit('admin_force_win',''); }

/* 12) Force Lose (reveal all mines and lose) */
function adminForceLose(){ revealAllMines(-1); audit('admin_force_lose',''); }

/* 13) Mass Flag / Unflag */
function adminMassFlag(){ for(let i=0;i<state.grid.length;i++) if(state.grid[i].mine) state.grid[i].flagged=true; state.flagsLeft=0; renderBoard(); audit('admin_mass_flag',''); }
function adminMassUnflag(){ for(let i=0;i<state.grid.length;i++) state.grid[i].flagged=false; state.flagsLeft = state.mines; renderBoard(); audit('admin_mass_unflag',''); }

/* 14) Auto-solve deterministic (very naive: reveal safe zeros and flags where number==count) */
function adminAutoSolve(){
  let changed=true; let iter=0;
  while(changed && iter<500){
    changed=false; iter++;
    for(let i=0;i<state.grid.length;i++){
      const g = state.grid[i];
      if(!g.revealed || g.num===0) continue;
      const [r,c0] = rc(i);
      let flagged=0, hidden=[];
      for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
        if(dr===0 && dc===0) continue;
        const nr=r+dr, nc=c0+dc; if(nr<0||nc<0||nr>=state.rows||nc>=state.cols) continue;
        const ni = idx(nr,nc); if(state.grid[ni].flagged) flagged++; else if(!state.grid[ni].revealed) hidden.push(ni);
      }
      if(g.num === flagged && hidden.length>0){
        hidden.forEach(h=>{ floodReveal(h); changed=true; });
      } else if(g.num - flagged === hidden.length && hidden.length>0){
        hidden.forEach(h=>{ state.grid[h].flagged=true; state.flagsLeft--; changed=true; });
      }
    }
  }
  renderBoard(); audit('admin_auto_solve','iter:'+iter);
}

/* 15) Step-by-step reveal (slow demo) */
function adminStepByStepReveal(){
  const q = [...Array(state.grid.length).keys()].filter(i=>!state.grid[i].revealed && !state.grid[i].mine);
  shuffle(q);
  let k=0;
  const timer = setInterval(()=>{ if(k>=q.length){ clearInterval(timer); return;} floodReveal(q[k]); k++; }, 220);
  audit('admin_step_by_step','started');
}

/* 16) Freeze timer */
let frozen=false;
function adminFreezeTimer(){ if(!frozen){ stopTimer(); frozen=true; audit('admin_freeze_timer','frozen'); } else { startTimer(); frozen=false; audit('admin_freeze_timer','resumed'); } }

/* 17) Warp time +60s */
function adminWarpTime(delta){ setTimerValue(state.elapsed + delta); audit('admin_warp_time', delta); }

/* 18) Set explicit timer */
function adminSetTimer(val){ setTimerValue(val); audit('admin_set_timer', val); }

/* 19) Snapshot export / import */
function adminExportSnapshot(){
  const snap = {state, grid: state.grid, meta:{time: new Date().toISOString()}};
  const blob = new Blob([JSON.stringify(snap,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='minesight_snapshot.json'; a.click(); URL.revokeObjectURL(url);
  audit('admin_export_snapshot','');
}
function adminImportSnapshotFile(file){
  const r = new FileReader(); r.onload = ()=> {
    try{
      const snap = JSON.parse(r.result);
      if(snap && snap.grid && snap.grid.length){ state.grid = snap.grid; renderBoard(); updateStats(); audit('admin_import_snapshot','ok'); } else alert('Invalid snapshot');
    }catch(e){ alert('Import error'); }
  }; r.readAsText(file);
}

/* 20) Add leaderboard entry (admin) */
function adminAddLB(name,time){ addLB(refs.mode.value, name, time); audit('admin_add_lb', `${name}:${time}`); }

/* 21) Spam leaderboard scale (simulate thousands) */
function adminSpamLB(n=200){
  for(let i=0;i<n;i++) addLB(refs.mode.value, `Bot${Math.floor(Math.random()*100000)}`, Math.floor(Math.random()*600)+10);
  audit('admin_spam_lb', n);
}

/* 22) Manual mine placement (apply indices) */
function adminApplyManualIndices(comma){
  const parts = String(comma).split(',').map(x=>parseInt(x.trim())).filter(x=>!isNaN(x) && x>=0 && x<state.grid.length);
  for(let i=0;i<state.grid.length;i++) state.grid[i].mine=false;
  parts.slice(0,state.mines).forEach(p=> state.grid[p].mine=true);
  // recompute numbers
  for(let i=0;i<state.grid.length;i++){ if(state.grid[i].mine) continue; let cnt=0; const [r,c0] = rc(i); for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){ if(dr===0&&dc===0) continue; const nr=r+dr, nc=c0+dc; if(nr>=0&&nc>=0&&nr<state.rows&&nc<state.cols) if(state.grid[idx(nr,nc)].mine) cnt++; } state.grid[i].num=cnt; }
  renderBoard(); audit('admin_manual_indices', parts.join(','));
}

/* 23) Apply seed-based generation */
function adminApplySeed(seed){
  createGrid(state.rows, state.cols, state.mines, seed, null);
  audit('admin_apply_seed', seed);
}

/* 24) Ban name from leaderboard (mark/strip) */
function adminBanName(name){
  const lb = loadLB(); Object.keys(lb).forEach(mode=>{ lb[mode]=lb[mode].filter(e=> e.name !== name); }); saveLB(lb); renderLB(); audit('admin_ban_name', name);
}

/* 25) Export leaderboard */
function adminExportLB(){
  const blob = new Blob([localStorage.getItem(KEYS.LB) || '{}'], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='minesight_lb.json'; a.click(); URL.revokeObjectURL(url);
  audit('admin_export_lb','');
}

/* 26) Export audit log */
function adminExportAudit(){
  const blob = new Blob([localStorage.getItem(KEYS.AUDIT) || '[]'], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='minesight_audit.json'; a.click(); URL.revokeObjectURL(url);
  audit('admin_export_audit','');
}

/* 27) Clear audit log */
function adminClearAudit(){ localStorage.removeItem(KEYS.AUDIT); renderAudit(); audit('admin_clear_audit',''); }

/* 28) Reset everything */
function adminResetAll(){ localStorage.removeItem(KEYS.LB); localStorage.removeItem(KEYS.AUDIT); createGrid(9,9,10); audit('admin_reset_all',''); renderLB(); renderAudit(); }

/* 29) Nuke board (new random) */
function adminNuke(){ createGrid(state.rows,state.cols,state.mines); audit('admin_nuke',''); }

/* 30) Scheduler demo: run action after ms delay */
function adminSchedule(actionName, delay){
  setTimeout(()=>{ if(actionName==='forceWin') adminForceWin(); else if(actionName==='forceLose') adminForceLose(); else if(actionName==='softRevealToggle') adminToggleSoftReveal(!state.softReveal); else if(actionName==='massFlag') adminMassFlag(); audit('admin_scheduled_run', actionName); }, delay);
  audit('admin_schedule', `${actionName}@${delay}ms`);
}

/* 31) Toggle confetti on win (visual) - simple switch stored in local variable */
let confettiEnabled=true; function adminToggleConfetti(on){ confettiEnabled = on; audit('admin_confetti', on); }

/* 32) Step reveal next unrevealed mine (admin visual) */
function adminStepRevealMine(){
  const idxs = [...Array(state.grid.length).keys()].filter(i => state.grid[i].mine && !state.grid[i].revealed);
  if(idxs.length===0) return; state.grid[idxs[0]].revealed=true; renderBoard(); audit('admin_step_reveal_mine', idxs[0]);
}

/* -------------------- Small utilities for UI -------------------- */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }

/* -------------------- Event wiring & UI behaviors -------------------- */
refs.start.addEventListener('click', ()=> { startGame(); });
refs.newBtn.addEventListener('click', ()=> { startGame(); });
refs.mode.addEventListener('change', ()=> {
  refs.customDiv.style.display = refs.mode.value==='custom' ? 'block' : 'none';
});
refs.adminMode.addEventListener('change', ()=> {
  refs.adminCustom.style.display = refs.adminMode.value === 'custom' ? 'block' : 'none';
});
refs.submitScore.addEventListener('click', ()=> { const name = refs.player.value || 'Anon'; addLB(refs.mode.value, name, state.elapsed || 0); audit('player_submit_score', `${name}:${state.elapsed}`); });
refs.clearLB.addEventListener('click', ()=> { if(confirm('Clear leaderboard?')) clearLB(); });
refs.copyBtn.addEventListener('click', ()=> { navigator.clipboard?.writeText(`${refs.mode.value} â€” ${state.won?'Win':'Loss'} â€” ${state.elapsed}s`); });

refs.hintBtn.addEventListener('click', ()=> { if(state.hintCount>0){ useHint(); state.hintCount--; audit('hint_used',''); } else alert('No hints left'); });

refs.openAdmin.addEventListener('click', ()=> { if(isAdmin()){ openAdminPanel(); } else { openLogin(); } });
refs.cancelLogin.addEventListener('click', ()=> { closeLogin(); });
refs.submitLogin.addEventListener('click', ()=> { const u=refs.loginUser.value.trim(), p=refs.loginPass.value; if(u===_ADMIN_CREDS.user && p===_ADMIN_CREDS.pass){ setAdmin(u); closeLogin(); openAdminPanel(); } else { alert('Invalid credentials'); } });
refs.adminLogoutBtn.addEventListener('click', ()=> { clearAdmin(); closeAdminPanel(); });

refs.adminApply.addEventListener('click', ()=> {
  const mode = refs.adminMode.value;
  if(mode==='custom'){ const r=parseInt(refs.adminRows.value||9), c=parseInt(refs.adminCols.value||9), m=parseInt(refs.adminMines.value||10); createGrid(r,c,m); } else { const map={beginner:[9,9,10], intermediate:[16,16,40], expert:[16,30,99]}; const [r,c,m]=map[mode]; createGrid(r,c,m); }
  audit('admin_apply_mode', refs.adminMode.value);
});
refs.adminStart.addEventListener('click', ()=> { startGame(); audit('admin_start_game',''); });

refs.adminSoftReveal.addEventListener('change', (e)=> adminToggleSoftReveal(!!e.target.checked));
refs.adminInvincible.addEventListener('change', (e)=> adminSetInvincible(!!e.target.checked));
refs.adminLockBoard.addEventListener('change', (e)=> adminLockBoard(!!e.target.checked));
refs.adminAutoFlag.addEventListener('change', (e)=> adminAutoFlag(!!e.target.checked));
refs.adminHighlight.addEventListener('change', (e)=> adminHighlightAreas(!!e.target.checked));
refs.adminShowSafePath.addEventListener('change', (e)=> adminShowSafePath(!!e.target.checked));
refs.adminNoHints.addEventListener('change', (e)=> adminDisableHints(!!e.target.checked));
refs.adminBlockInput.addEventListener('change', (e)=> adminBlockInput(!!e.target.checked));
refs.adminGhostMode.addEventListener('change', (e)=> adminGhostReveal(!!e.target.checked));
refs.adminStepMode.addEventListener('change', (e)=> { /* step mode toggled; adminStepRevealNext will reveal on demand */ audit('admin_step_mode', !!e.target.checked); });

refs.forceWin.addEventListener('click', ()=> { if(isAdmin()) adminForceWin(); else openLogin(); });
refs.forceLose.addEventListener('click', ()=> { if(isAdmin()) adminForceLose(); else openLogin(); });
refs.massFlagBtn.addEventListener('click', ()=> { if(isAdmin()) adminMassFlag(); else openLogin(); });
refs.massUnflagBtn.addEventListener('click', ()=> { if(isAdmin()) adminMassUnflag(); else openLogin(); });
refs.autoSolveBtn.addEventListener('click', ()=> { if(isAdmin()) adminAutoSolve(); else openLogin(); });
refs.stepRevealBtn.addEventListener('click', ()=> { if(isAdmin()) adminStepRevealNext(); else openLogin(); });

refs.freezeTimerBtn.addEventListener('click', ()=> { adminFreezeTimer(); });
refs.warpTimeBtn.addEventListener('click', ()=> { adminWarpTime(60); });
refs.setTimerBtn.addEventListener('click', ()=> { const val = parseInt(prompt('Set timer seconds (number):', String(state.elapsed))); if(!isNaN(val)) adminSetTimer(val); });

refs.snapshotExport.addEventListener('click', ()=> { if(isAdmin()) adminExportSnapshot(); else openLogin(); });
refs.snapshotLoadBtn.addEventListener('click', ()=> { refs.snapshotImport.click(); });
refs.snapshotImport.addEventListener('change', (ev)=> { if(ev.target.files[0] && isAdmin()) adminImportSnapshotFile(ev.target.files[0]); });

refs.lbAdd.addEventListener('click', ()=> { if(isAdmin()) adminAddLB(refs.lbName.value||'Admin', parseInt(refs.lbTime.value||0)); else openLogin(); });
refs.exportLB.addEventListener('click', ()=> { if(isAdmin()) adminExportLB(); else openLogin(); });
refs.clearLBAdmin.addEventListener('click', ()=> { if(isAdmin() && confirm('Clear leaderboard?')) { clearLB(); audit('admin_clear_lb',''); } else openLogin(); });
refs.spamLB.addEventListener('click', ()=> { if(isAdmin()) adminSpamLB(300); else openLogin(); });

refs.applyManualBtn.addEventListener('click', ()=> { if(isAdmin()) adminApplyManualIndices(refs.manualIndices.value); else openLogin(); });
refs.applySeed.addEventListener('click', ()=> { if(isAdmin()) adminApplySeed(refs.seedInput.value); else openLogin(); });

refs.exportAudit.addEventListener('click', ()=> { if(isAdmin()) adminExportAudit(); else openLogin(); });
refs.clearAudit.addEventListener('click', ()=> { if(isAdmin() && confirm('Clear audit log?')) adminClearAudit(); else openLogin(); });

refs.clearAll.addEventListener('click', ()=> { if(isAdmin() && confirm('Clear LB and Audit?')){ localStorage.removeItem(KEYS.LB); localStorage.removeItem(KEYS.AUDIT); renderLB(); renderAudit(); audit('admin_clear_all',''); } else openLogin(); });
refs.resetAll.addEventListener('click', ()=> { if(isAdmin() && confirm('Reset everything?')) adminResetAll(); else openLogin(); });
refs.nukeBoard.addEventListener('click', ()=> { if(isAdmin() && confirm('Nuke board (new random)?')) adminNuke(); else openLogin(); });

refs.softShowBtn.addEventListener('click', ()=> { if(isAdmin()) { adminToggleSoftReveal(!state.softReveal); refs.adminSoftReveal.checked = state.softReveal; } else openLogin(); });
refs.themeSel.addEventListener('change', ()=> { document.documentElement.setAttribute('data-theme', refs.themeSel.value==='dark'? 'dark':'light'); });

refs.undoBtn.addEventListener('click', ()=> { /* not fully implemented: placeholder */ alert('Undo not implemented in this demo'); });
refs.toggleCompact.addEventListener('click', ()=> { state.compact = !state.compact; renderBoard(); });

refs.resetHints.addEventListener('click', ()=> { state.hintCount = 3; updateStats(); audit('reset_hints',''); });

/* -------------------- Hint implement simple reveal safe */
function useHint(){
  for(let i=0;i<state.grid.length;i++){
    if(!state.grid[i].revealed && !state.grid[i].mine && !state.grid[i].flagged){
      floodReveal(i); updateStats(); audit('use_hint', i); return;
    }
  }
}

/* -------------------- Login / Admin panel open/close -------------------- */
function openLogin(){ refs.loginModal.classList.add('open'); refs.loginModal.style.display='flex'; refs.loginUser.focus(); }
function closeLogin(){ refs.loginModal.classList.remove('open'); refs.loginModal.style.display='none'; refs.loginUser.value=''; refs.loginPass.value=''; }
function openAdminPanel(){ if(!isAdmin()) return openLogin(); refs.adminModal.classList.add('open'); refs.adminModal.style.display='flex'; refs.adminName.textContent = JSON.parse(sessionStorage.getItem(KEYS.ADMIN)||'{}').user || 'Admin'; renderAudit(); renderLB(); }
function closeAdminPanel(){ refs.adminModal.classList.remove('open'); refs.adminModal.style.display='none'; }

function startGame(){
  const m = refs.mode.value;
  if(m==='custom'){ const r = clamp(parseInt(refs.rows.value||9),5,80), c=clamp(parseInt(refs.cols.value||9),5,120), mm=clamp(parseInt(refs.mines.value||10),1,r*c-1); createGrid(r,c,mm); } else {
    const map = { beginner:[9,9,10], intermediate:[16,16,40], expert:[16,30,99] };
    const [r,c,mm] = map[m]; createGrid(r,c,mm);
  }
  state.compact = refs.compact.checked; state.autoOpen = refs.autoOpen.checked; state.sounds = refs.sounds.checked;
  renderLB(); renderAudit();
}

/* -------------------- Initial load -------------------- */
(function init(){
  refs.customDiv = document.getElementById('customDiv');
  refs.customDiv.style.display = 'none';
  refs.adminCustom.style.display = 'none';
  // expose some minimal UI state to admin controls defaults
  createGrid(9,9,10); renderLB(); renderAudit();
  if(sessionStorage.getItem(KEYS.ADMIN)){ refs.adminBadge.style.display='inline-block'; refs.adminName.textContent = JSON.parse(sessionStorage.getItem(KEYS.ADMIN)).user; }
  // close modals on outside-click
  document.querySelectorAll('.modal').forEach(mod=> mod.addEventListener('click', e=>{ if(e.target===mod){ mod.classList.remove('open'); mod.style.display='none'; } }));
})();

/* -------------------- Utilities for file export/import etc (already used above) -------------------- */
function adminExportAudit(){ const blob = new Blob([localStorage.getItem(KEYS.AUDIT)||'[]'], {type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='audit.json'; a.click(); URL.revokeObjectURL(url); audit('admin_export_audit',''); }
function adminExportLB(){ const blob = new Blob([localStorage.getItem(KEYS.LB)||'{}'], {type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='lb.json'; a.click(); URL.revokeObjectURL(url); audit('admin_export_lb',''); }

/* -------------------- Simple confetti on win (if enabled) -------------------- */
const confettiCanvas = document.getElementById('confetti'); const ctx = confettiCanvas.getContext('2d');
confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight;
window.addEventListener('resize', ()=> { confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; });
function confettiBurst(){
  if(!confettiEnabled) return;
  const pieces = [];
  const colors = ['#2563eb','#ffb400','#ff4d4f','#10b981','#7c3aed'];
  for(let i=0;i<120;i++) pieces.push({x:Math.random()*confettiCanvas.width,y:-50+Math.random()*-600,vx:(Math.random()-0.5)*6,vy:Math.random()*6+3,size:Math.random()*8+6,color:colors[Math.floor(Math.random()*colors.length)],rot:Math.random()*360,rotS:Math.random()*8-4,life:Math.random()*300+300});
  let last = performance.now();
  (function frame(t){ const dt = t-last; last=t; ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height); for(const p of pieces){ p.x+=p.vx; p.y+=p.vy; p.vy+=0.06; p.rot+=p.rotS; p.life-=dt; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180); ctx.fillStyle=p.color; ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size*0.6); ctx.restore(); } if(pieces.some(p=>p.life>0 && p.y < confettiCanvas.height+50)) requestAnimationFrame(frame); else ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height); })(last);
}

/* -------------------- Small helper functions used earlier -------------------- */
function renderLB(){ renderLB(); } // placeholder to satisfy earlier calls (replace with proper call)
function renderLB(){ const mode = refs.mode.value; const lb = JSON.parse(localStorage.getItem(KEYS.LB)||'{}')[mode]||[]; refs.leaderboard.innerHTML=''; if(lb.length===0){ refs.leaderboard.textContent='No scores yet'; return; } lb.slice(0,10).forEach((e,i)=>{ const d=document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.padding='6px'; d.style.borderRadius='6px'; d.style.background='linear-gradient(180deg, rgba(0,0,0,0.02), rgba(255,255,255,0.02))'; d.innerHTML=`<div>${i+1}. ${escapeHtml(e.name)}</div><div style="font-weight:800">${e.time}s</div>`; refs.leaderboard.appendChild(d); }); }
function renderAudit(){ const arr = JSON.parse(localStorage.getItem(KEYS.AUDIT)||'[]'); refs.audit.innerHTML=''; if(arr.length===0){ refs.audit.textContent='No admin actions yet'; return; } arr.slice(0,200).forEach(a=>{ const d=document.createElement('div'); d.style.padding='6px'; d.style.borderBottom='1px solid rgba(0,0,0,0.04)'; d.style.fontSize='13px'; d.style.color='var(--muted)'; d.textContent = `${a.ts} â€” ${a.action}${a.detail?(' â€” '+a.detail):''}`; refs.audit.appendChild(d); }); }

/* -------------------- Helper: load LB utility used in admin functions -------------------- */
function loadLB(){ try{return JSON.parse(localStorage.getItem(KEYS.LB)||'{}')}catch(e){return{}} }
function saveLB(lb){ localStorage.setItem(KEYS.LB, JSON.stringify(lb)); }

/* -------------------- Exports to window for debugging (optional) -------------------- */
window.MinesightAdmin = { adminToggleSoftReveal, adminSetInvincible, adminLockBoard, adminAutoFlag, adminHighlightAreas, adminShowSafePath, adminDisableHints, adminBlockInput, adminGhostReveal, adminStepRevealNext, adminForceWin, adminForceLose, adminMassFlag, adminMassUnflag, adminAutoSolve, adminStepByStepReveal, adminFreezeTimer, adminWarpTime, adminSetTimer, adminExportSnapshot, adminImportSnapshotFile, adminAddLB, adminSpamLB, adminApplyManualIndices, adminApplySeed, adminBanName, adminExportLB, adminExportAudit, adminClearAudit, adminResetAll, adminNuke, adminSchedule };

/* -------------------- End of script -------------------- */
</script>
</body>
</html>
