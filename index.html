 <!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Minesight Pro â€” Working Game + Categorized Admin Panel</title>
<meta name="description" content="Minesight Pro â€” polished Minesweeper with categorized Admin panel (Admin vs Abuse) and colored numbers."/>
<style>
  :root{
    --bg:linear-gradient(180deg,#eef7ff,#f8fbff);
    --card:#fff; --accent:#2563eb; --muted:#6b7280; --text:#062235;
    --cell:#eef6ff; --cell-border:#cddaf2; --danger:#ff4d4f; --flag:#ffb400;
    --radius:12px;
  }
  [data-theme="dark"]{
    --bg:linear-gradient(180deg,#051022,#071428);
    --card:#071428; --accent:#60a5fa; --muted:#9aa7bf; --text:#e6eef6;
    --cell:#0b1220; --cell-border:#1f2937; --danger:#ff6b6b; --flag:#ffc870;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text)}
  .container{max-width:1200px;margin:28px auto;padding:12px;display:grid;grid-template-columns:360px 1fr;gap:18px}
  .panel{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 12px 36px rgba(2,6,23,0.06);border:1px solid rgba(0,0,0,0.04)}
  header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:6px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:52px;height:52px;border-radius:10px;display:grid;place-items:center;color:white;font-weight:900;background:linear-gradient(180deg,var(--accent),color-mix(in srgb,var(--accent) 70%,black));box-shadow:0 10px 30px rgba(37,99,235,0.12)}
  .title{font-size:18px;margin:0}
  .subtitle{font-size:13px;color:var(--muted);margin:0}

  .controls{display:flex;flex-direction:column;gap:10px}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  select,input[type=number],input[type=text]{width:100%;padding:8px;border-radius:8px;border:1px solid var(--cell-border);background:var(--cell);color:var(--text)}

  .stats{display:flex;gap:8px;margin-top:6px}
  .stat{padding:8px;border-radius:8px;background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(255,255,255,0.02));min-width:92px;text-align:center;font-weight:800;border:1px solid var(--cell-border)}

  .btn{padding:9px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
  .btn.primary{background:linear-gradient(180deg,var(--accent),color-mix(in srgb,var(--accent) 80%,black));color:white;box-shadow:0 6px 18px rgba(37,99,235,0.12)}
  .btn.ghost{background:transparent;border:1px solid var(--cell-border);color:var(--text)}

  /* Board side */
  .board-shell{display:flex;flex-direction:column;gap:12px;align-items:center}
  .topbar{width:100%;display:flex;justify-content:space-between;align-items:center;gap:12px}
  .pill{background:rgba(255,255,255,0.6);padding:8px 12px;border-radius:10px;font-weight:800;border:1px solid rgba(255,255,255,0.04);min-width:110px;text-align:center}
  .board-wrap{padding:12px;border-radius:12px;min-height:420px;display:flex;align-items:center;justify-content:center;width:100%;overflow:auto}
  .board{display:grid;gap:6px;touch-action:manipulation}

  .cell{width:40px;aspect-ratio:1/1;border-radius:8px;background:var(--cell);border:1px solid var(--cell-border);display:grid;place-items:center;font-weight:800;font-size:16px;user-select:none;cursor:pointer;position:relative}
  .cell:active{transform:translateY(1px) scale(.998)}
  .cell.revealed{background:linear-gradient(180deg,#f8fafc,#eef3ff);box-shadow:none;cursor:default}
  .cell.flag{color:var(--flag)}
  .cell.mine{color:var(--danger)}
  .cell.soft::after{content:"ðŸ’£";position:absolute;font-size:16px;pointer-events:none;opacity:0.95}
  .cell[data-num="1"]{color:#2563eb}   /* blue */
  .cell[data-num="2"]{color:#16a34a}   /* green */
  .cell[data-num="3"]{color:#dc2626}   /* red */
  .cell[data-num="4"]{color:#1e3a8a}   /* dark blue */
  .cell[data-num="5"]{color:#7c2d12}   /* brown */
  .cell[data-num="6"]{color:#0891b2}   /* teal */
  .cell[data-num="7"]{color:#111827}   /* black */
  .cell[data-num="8"]{color:#374151}   /* gray */

  /* Admin modal */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);align-items:center;justify-content:center;z-index:9999}
  .modal.open{display:flex}
  .admin-card{width:920px;max-width:96%;border-radius:12px;padding:12px;background:var(--card);box-shadow:0 20px 60px rgba(3,6,23,0.35);border:1px solid rgba(0,0,0,0.06);color:var(--text);display:flex;flex-direction:column;gap:12px}
  .admin-header{display:flex;justify-content:space-between;align-items:center}
  .admin-body{display:grid;grid-template-columns:1fr 1fr;gap:12px;max-height:64vh;overflow:auto;padding:6px}
  .section{background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(255,255,255,0.02));padding:8px;border-radius:8px;border:1px solid var(--cell-border)}
  .section h4{margin:0 0 8px 0}
  .audit{max-height:28vh;overflow:auto;padding:6px;border-radius:8px;border:1px solid var(--cell-border);background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(255,255,255,0.02));color:var(--muted);font-size:13px}

  /* extra actions grid */
  .actions-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .action-btn{padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer;font-weight:700}

  /* responsive */
  @media (max-width:1000px){ .container{grid-template-columns:1fr} .board-wrap{min-height:320px} .cell{width:34px} .admin-body{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="container" id="app">
    <header class="panel">
      <div class="brand">
        <div class="logo" aria-hidden="true">MP</div>
        <div>
          <h1 class="title">Minesight Pro</h1>
          <p class="subtitle">Pro Minesweeper â€” Admin & Operator Console</p>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="themeSwitch" aria-label="theme">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
        <button id="newGame" class="btn primary">New Game</button>
        <button id="openAdmin" class="btn ghost">Admin Panel</button>
        <div id="adminBadge" style="display:none;padding:8px;border-radius:8px;background:linear-gradient(180deg,#eef6ff,#f8fbff);border:1px solid var(--cell-border);font-weight:700;color:var(--muted)">ADMIN</div>
      </div>
    </header>

    <!-- Left: Controls -->
    <aside class="panel">
      <div class="controls">
        <div>
          <label for="mode">Mode</label>
          <select id="mode">
            <option value="beginner">Beginner â€” 9 Ã— 9 Â· 10</option>
            <option value="intermediate">Intermediate â€” 16 Ã— 16 Â· 40</option>
            <option value="expert">Expert â€” 16 Ã— 30 Â· 99</option>
            <option value="custom">Custom</option>
          </select>
        </div>

        <div id="customArea" style="display:none">
          <label>Custom board (rows Â· cols Â· mines)</label>
          <div style="display:flex;gap:8px">
            <input id="rows" type="number" min="5" max="60" value="9">
            <input id="cols" type="number" min="5" max="120" value="9">
            <input id="mines" type="number" min="1" max="200" value="10">
          </div>
        </div>

        <div class="stats">
          <div class="stat" id="mineCount">Mines: 10</div>
          <div class="stat" id="flagCount">Flags: 0</div>
          <div class="stat" id="timeCount">Time: 0s</div>
        </div>

        <div style="display:flex;gap:8px">
          <button id="startBtn" class="btn primary">Start</button>
          <button id="hintBtn" class="btn ghost">Hint</button>
        </div>

        <div style="margin-top:10px">
          <label>Options</label>
          <div style="display:flex;flex-direction:column;gap:8px">
            <label><input id="autoOpen" type="checkbox" checked> Auto-open (chording)</label>
            <label><input id="soundOn" type="checkbox" checked> Sound</label>
            <label><input id="compact" type="checkbox"> Compact board</label>
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Leaderboard</label>
          <div id="leaderboard" style="min-height:80px;display:flex;flex-direction:column;gap:6px"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="playerName" placeholder="Your name">
            <button id="submitScore" class="btn ghost">Submit</button>
            <button id="clearLB" class="btn ghost">Clear</button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Right: Board -->
    <section class="panel board-shell">
      <div class="topbar">
        <div class="status">
          <div class="pill" id="status">Ready</div>
          <div class="pill" id="boardInfo">9 Ã— 9 Â· Beginner</div>
        </div>

        <div style="display:flex;gap:8px">
          <button id="softToggle" class="btn ghost">Soft-Show Mines</button>
          <button id="copyBtn" class="btn ghost">Copy Result</button>
          <button id="resetHints" class="btn ghost">Reset Hints</button>
        </div>
      </div>

      <div class="board-wrap">
        <div id="board" class="board" role="grid" tabindex="0" aria-label="Mines grid"></div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div style="display:flex;gap:8px">
          <button id="undo" class="btn ghost">Undo</button>
          <button id="toggleCompact" class="btn ghost">Toggle Compact</button>
        </div>
        <div style="color:var(--muted);font-size:13px">Minesight Pro â€” polished demo</div>
      </div>
    </section>
  </div>

  <!-- Admin Login Modal -->
  <div id="loginModal" class="modal" aria-hidden="true">
    <div class="admin-card" style="max-width:480px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 style="margin:0">Admin Sign In</h3>
          <div style="color:var(--muted);font-size:13px">Enter administrator credentials to open the control center</div>
        </div>
        <div><button id="loginClose" class="btn ghost">Cancel</button></div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <input id="loginUser" placeholder="Username" />
        <input id="loginPass" placeholder="Password" type="password" />
      </div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button id="loginSubmit" class="btn primary">Sign in</button>
      </div>
    </div>
  </div>

  <!-- Admin Panel Modal (categorized) -->
  <div id="adminModal" class="modal" aria-hidden="true">
    <div class="admin-card" role="dialog" aria-modal="true">
      <div class="admin-header">
        <div>
          <h2 style="margin:0">Admin Control Center</h2>
          <div style="color:var(--muted)">Separated: Administrative (safe) vs Abuse (operator) tools. All actions are audited.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div id="adminUserBadgeTop" style="font-weight:800;color:var(--muted)"></div>
          <button id="adminLogout" class="btn ghost">Logout</button>
        </div>
      </div>

      <div class="admin-body">
        <!-- Administrative (safe) -->
        <div class="section">
          <h4>Administrative</h4>
          <div style="display:flex;flex-direction:column;gap:8px">
            <label>Mode</label>
            <select id="adminMode"><option value="beginner">Beginner</option><option value="intermediate">Intermediate</option><option value="expert">Expert</option><option value="custom">Custom</option></select>
            <div id="adminCustomArea" style="display:none">
              <label>Rows Â· Cols Â· Mines</label>
              <div style="display:flex;gap:8px">
                <input id="adminRows" type="number" min="5" max="60" value="9">
                <input id="adminCols" type="number" min="5" max="120" value="9">
                <input id="adminMines" type="number" min="1" max="200" value="10">
              </div>
            </div>
            <div style="display:flex;gap:8px">
              <button id="adminApply" class="btn primary">Apply</button>
              <button id="adminStart" class="btn ghost">Start</button>
            </div>

            <hr/>

            <h5 style="margin:0">State & Persistence</h5>
            <div style="display:flex;gap:8px">
              <button id="exportSnapshot" class="btn ghost">Export Snapshot</button>
              <input id="importSnapshot" type="file" accept="application/json" style="display:none" />
              <button id="importSnapshotBtn" class="btn ghost">Import Snapshot</button>
            </div>

            <label style="margin-top:6px">Seed</label>
            <div style="display:flex;gap:8px">
              <input id="seedValue" placeholder="seed (string or number)">
              <button id="applySeedBtn" class="btn ghost">Apply Seed</button>
            </div>

            <hr/>

            <h5 style="margin:0">Timer</h5>
            <div style="display:flex;gap:8px;">
              <button id="freezeTimer" class="btn ghost">Freeze / Resume</button>
              <button id="warp60" class="btn ghost">Warp +60s</button>
              <button id="setTimerManual" class="btn ghost">Set Timeâ€¦</button>
            </div>

            <hr/>
            <h5 style="margin:0">Leaderboard</h5>
            <div style="display:flex;gap:8px">
              <input id="lbAddName" placeholder="name">
              <input id="lbAddTime" placeholder="time (s)">
              <button id="lbAddBtn" class="btn ghost">Add</button>
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="exportLB" class="btn ghost">Export LB</button>
              <button id="clearLBAdmin" class="btn ghost">Clear LB</button>
            </div>
          </div>
        </div>

        <!-- Abuse / Operator -->
        <div class="section">
          <h4>Abuse / Operator</h4>
          <div style="display:flex;flex-direction:column;gap:8px">
            <label><input id="adminSoftReveal" type="checkbox"> Soft-reveal (visual only)</label>
            <label><input id="adminInvincible" type="checkbox"> Invincible (click mines won't lose)</label>
            <label><input id="adminLock" type="checkbox"> Lock board (disable user)</label>
            <label><input id="adminAutoFlag" type="checkbox"> Auto-flag all mines</label>
            <label><input id="adminAutoSolve" type="checkbox"> Auto-solver (naive)</label>
            <label><input id="adminGhost" type="checkbox"> Ghost reveal (show/hide)</label>
            <label><input id="adminStep" type="checkbox"> Step reveal mode</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
              <button id="forceWin" class="btn ghost">Force Win</button>
              <button id="forceLose" class="btn ghost">Force Lose</button>
              <button id="massFlag" class="btn ghost">Mass Flag</button>
              <button id="massUnflag" class="btn ghost">Mass Unflag</button>
              <button id="stepSafe" class="btn ghost">Step Reveal Safe</button>
              <button id="stepMine" class="btn ghost">Step Reveal Mine</button>
            </div>

            <hr/>
            <h5 style="margin:0">Manual Board Designer</h5>
            <label>Manual mine indices (comma-separated)</label>
            <input id="manualIndices" placeholder="e.g. 0,5,12">
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="applyManual" class="btn ghost">Apply Manual</button>
              <button id="randomizeSeed" class="btn ghost">Randomize Seed</button>
            </div>

            <hr/>
            <h5 style="margin:0">Audit & Rapid Actions</h5>
            <div class="actions-grid" id="placeholderActions"></div>
            <div style="display:flex;gap:8px;margin-top:10px">
              <button id="exportAudit" class="btn ghost">Export Audit</button>
              <button id="clearAudit" class="btn ghost">Clear Audit</button>
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="audit" id="adminAudit">No admin actions yet</div>
        <div style="display:flex;gap:8px">
          <button id="closeAdmin" class="btn ghost">Close</button>
        </div>
      </div>
    </div>
  </div>

<script>
/*
  Minesight Pro â€” Working Game + Categorized Admin Panel
  Demo admin credentials (hidden in script): Sam / test
  For production: implement server-side auth & secure audit storage.

  Save as a single HTML file and open in browser.
*/

/* -------------------- Demo admin creds (hidden from UI) -------------------- */
const DEMO_ADMIN = { user: 'Sam', pass: 'test' };

/* -------------------- DOM refs -------------------- */
const $ = (id)=>document.getElementById(id);
const boardEl = $('board');
const modeSel = $('mode'), customArea = $('customArea'), rowsInput = $('rows'), colsInput = $('cols'), minesInput = $('mines');
const startBtn = $('startBtn'), hintBtn = $('hintBtn'), mineCountEl = $('mineCount'), flagCountEl = $('flagCount'), timeCountEl = $('timeCount'), statusEl = $('status');
const boardInfo = $('boardInfo');
const compactCheckbox = $('compact'), autoOpenChk = $('autoOpen'), soundOnChk = $('soundOn');
const leaderboardEl = $('leaderboard'), playerNameEl = $('playerName'), submitScoreBtn = $('submitScore'), clearLBBtn = $('clearLB');
const themeSwitch = $('themeSwitch'), newGameBtn = $('newGame'), openAdminBtn = $('openAdmin'), adminBadge = $('adminBadge');
const softToggle = $('softToggle'), copyBtn = $('copyBtn'), resetHints = $('resetHints'), undoBtn = $('undo'), toggleCompact = $('toggleCompact');

/* admin refs */
const loginModal = $('loginModal'), loginUser = $('loginUser'), loginPass = $('loginPass'), loginSubmit = $('loginSubmit'), loginClose = $('loginClose');
const adminModal = $('adminModal'), adminUserBadgeTop = $('adminUserBadgeTop'), adminLogout = $('adminLogout'), adminMode = $('adminMode'), adminCustomArea = $('adminCustomArea'), adminRows = $('adminRows'), adminCols = $('adminCols'), adminMines = $('adminMines'), adminApply = $('adminApply'), adminStart = $('adminStart');
const exportSnapshotBtn = $('exportSnapshot'), importSnapshotInput = $('importSnapshot'), importSnapshotBtn = $('importSnapshotBtn'), seedValue = $('seedValue'), applySeedBtn = $('applySeedBtn');
const freezeTimerBtn = $('freezeTimer'), warp60Btn = $('warp60'), setTimerBtn = $('setTimerManual');
const lbAddName = $('lbAddName'), lbAddTime = $('lbAddTime'), lbAddBtn = $('lbAddBtn'), exportLB = $('exportLB'), clearLBAdmin = $('clearLBAdmin');
const adminSoftReveal = $('adminSoftReveal'), adminInvincible = $('adminInvincible'), adminLock = $('adminLock'), adminAutoFlag = $('adminAutoFlag'), adminAutoSolve = $('adminAutoSolve'), adminGhost = $('adminGhost'), adminStep = $('adminStep');
const forceWinBtn = $('forceWin'), forceLoseBtn = $('forceLose'), massFlagBtn = $('massFlag'), massUnflagBtn = $('massUnflag'), stepSafeBtn = $('stepSafe'), stepMineBtn = $('stepMine');
const manualIndices = $('manualIndices'), applyManualBtn = $('applyManual'), randomizeSeedBtn = $('randomizeSeed');
const placeholderActionsEl = $('placeholderActions'), exportAuditBtn = $('exportAudit'), clearAuditBtn = $('clearAudit'), adminAuditEl = $('adminAudit'), closeAdminBtn = $('closeAdmin');

/* confetti */
const confettiCanvas = document.createElement('canvas'); confettiCanvas.id = 'confettiCanvas'; confettiCanvas.style.position='fixed'; confettiCanvas.style.left=0; confettiCanvas.style.top=0; confettiCanvas.style.width='100%'; confettiCanvas.style.height='100%'; confettiCanvas.style.pointerEvents='none'; confettiCanvas.style.zIndex=9999; document.body.appendChild(confettiCanvas);
confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; window.addEventListener('resize', ()=>{ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; });

/* -------------------- Storage keys -------------------- */
const KEY = { LB: 'mp_lb_v1', AUDIT: 'mp_audit_v1', ADMIN: 'mp_admin_v1' };

/* -------------------- Game state -------------------- */
let state = {
  rows:9, cols:9, mines:10,
  grid: [], // {mine, revealed, flagged, num}
  started:false, startTs:0, elapsed:0, timerId:null,
  flagsLeft:10, revealedCount:0, gameOver:false, won:false,
  firstClick:true, hintCount:3,
  // admin toggles
  softReveal:false, invincible:false, locked:false, ghost:false, stepMode:false
};

/* -------------------- Utilities -------------------- */
function nowISO(){ return new Date().toISOString(); }
function audit(action, detail=''){ const arr = JSON.parse(localStorage.getItem(KEY.AUDIT)||'[]'); arr.unshift({ts:nowISO(), action, detail}); localStorage.setItem(KEY.AUDIT, JSON.stringify(arr.slice(0,2000))); renderAdminAudit(); }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* -------------------- Timer -------------------- */
function startTimer(){
  if(state.timerId) return;
  state.startTs = Date.now() - state.elapsed*1000;
  state.timerId = setInterval(()=> { state.elapsed = Math.floor((Date.now() - state.startTs)/1000); timeCountEl.textContent = `Time: ${state.elapsed}s`; }, 500);
}
function stopTimer(){ if(state.timerId){ clearInterval(state.timerId); state.timerId = null; } }

/* -------------------- Grid creation (first-click safe) -------------------- */
function initGrid(rows,cols,mines){
  state.rows = rows; state.cols = cols; state.mines = mines;
  state.grid = Array.from({length: rows*cols}, ()=> ({ mine:false, revealed:false, flagged:false, num:0 }));
  state.firstClick = true;
  state.started = false; stopTimer(); state.elapsed=0; state.revealedCount=0; state.flagsLeft = mines; state.gameOver=false; state.won=false; state.hintCount=3; state.softReveal=false; state.invincible=false; state.locked=false;
  renderBoard();
  renderUIAfterReset();
  audit('init_grid', `${rows}x${cols} mines:${mines}`);
}

/* place mines after first click to ensure safety */
function placeMinesAfterClick(firstIdx, seed=null, manualIndices=null){
  const total = state.rows * state.cols;
  const all = [...Array(total).keys()];
  // ensure first index and neighbors are excluded from mines for safety
  const [fr, fc] = idxToRC(firstIdx);
  const excluded = new Set([firstIdx]);
  for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
    const nr = fr+dr, nc = fc+dc;
    if(nr>=0 && nr<state.rows && nc>=0 && nc<state.cols) excluded.add(rcToIdx(nr,nc));
  }

  // manual indices override (optional)
  let minePositions = new Set();
  if(Array.isArray(manualIndices) && manualIndices.length){
    manualIndices.forEach(i => { if(!excluded.has(i) && i>=0 && i<total) minePositions.add(i); });
  }

  if(seed !== null && seed !== undefined && seed !== ''){
    // simple seeded RNG to select mine indices
    let s=0; for(const ch of String(seed)) s=(s<<5)-s+ch.charCodeAt(0);
    function rng(){ s^=s<<13; s^=s>>>17; s^=s<<5; return Math.abs(s) % total; }
    while(minePositions.size < state.mines){
      const p = rng();
      if(!excluded.has(p)) minePositions.add(p);
    }
  } else {
    const candidates = all.filter(i => !excluded.has(i) && !(Array.isArray(manualIndices) && manualIndices.includes(i)));
    shuffle(candidates);
    let need = state.mines - (minePositions.size);
    for(let i=0;i<need && i<candidates.length;i++) minePositions.add(candidates[i]);
    // if manual provided but less than mines, fill remaining
    if(Array.isArray(manualIndices) && manualIndices.length){
      // manual were already added; ensure total count
      if(minePositions.size < state.mines){
        const extra = all.filter(i => !minePositions.has(i) && !excluded.has(i));
        shuffle(extra);
        for(let i=0;i<state.mines - minePositions.size;i++) minePositions.add(extra[i]);
      }
    }
  }

  // set mines
  for(const i of minePositions) state.grid[i].mine = true;
  // compute numbers
  for(let i=0;i<state.grid.length;i++){
    if(state.grid[i].mine) continue;
    const [r,c] = idxToRC(i);
    let cnt=0;
    for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
      if(dr===0 && dc===0) continue;
      const nr=r+dr, nc=c+dc;
      if(nr>=0 && nr<state.rows && nc>=0 && nc<state.cols){ if(state.grid[rcToIdx(nr,nc)].mine) cnt++; }
    }
    state.grid[i].num = cnt;
  }
}

/* index helpers */
function idxToRC(i){ return [Math.floor(i / state.cols), i % state.cols]; }
function rcToIdx(r,c){ return r*state.cols + c; }

/* -------------------- Rendering -------------------- */
function renderBoard(){
  boardEl.innerHTML = '';
  boardEl.style.gridTemplateColumns = `repeat(${state.cols}, ${$('compact').checked ? '34px' : '40px'})`;
  boardEl.style.gap = $('compact').checked ? '4px' : '6px';
  for(let i=0;i<state.grid.length;i++){
    const g = state.grid[i];
    const cell = document.createElement('button');
    cell.className = 'cell';
    cell.setAttribute('data-idx', i);
    cell.tabIndex = 0;
    // content & classes
    cell.textContent = '';
    cell.classList.toggle('revealed', g.revealed);
    if(g.revealed){
      if(g.mine){ cell.classList.add('mine'); cell.textContent = 'ðŸ’£'; }
      else if(g.num > 0){ cell.textContent = g.num; cell.setAttribute('data-num', g.num); }
    } else {
      if(g.flagged){ cell.classList.add('flag'); cell.textContent = 'âš‘'; }
      if(state.softReveal && g.mine && isAdmin()) cell.classList.add('soft'); else cell.classList.remove('soft');
    }
    // events
    cell.addEventListener('click', (ev)=> { if(state.locked) return; onCellClick(i); });
    cell.addEventListener('contextmenu', (ev)=> { ev.preventDefault(); if(state.locked) return; toggleFlag(i); });
    cell.addEventListener('keydown', (ev)=> { if(state.locked) return; if(ev.key==='Enter' || ev.key===' ') { ev.preventDefault(); onCellClick(i); } if(ev.key.toLowerCase()==='f'){ ev.preventDefault(); toggleFlag(i); }});
    setupLongPress(cell, ()=> { if(state.locked) return; toggleFlag(i); });
    boardEl.appendChild(cell);
  }
  boardInfo.textContent = `${state.rows} Ã— ${state.cols} Â· ${modeSel.options[modeSel.selectedIndex].text.split('â€”')[0].trim()}`;
  updateCounts();
}

/* -------------------- Game interactions -------------------- */
function onCellClick(i){
  if(state.gameOver) return;
  const cell = state.grid[i];
  if(cell.revealed){
    if(autoOpenChk.checked) chord(i);
    return;
  }
  if(cell.flagged) return;

  // first click: place mines ensuring clicked cell safe
  if(state.firstClick){
    placeMinesAfterClick(i);
    state.firstClick = false;
    state.started = true;
    startTimer();
  }

  // if mine clicked
  if(cell.mine){
    if(state.invincible){ // visual only
      flashCell(i); audit('admin_invincible_click', i); return;
    }
    // lose
    revealAllMines(i);
    endGame(false);
    return;
  }

  // reveal
  state.lastAction = { type:'reveal', indices:[] };
  floodReveal(i);
  renderBoard();
  audit('reveal', `idx:${i}`);
  checkWin();
}

/* toggle flag */
function toggleFlag(i){
  if(state.gameOver) return;
  const g = state.grid[i];
  if(g.revealed) return;
  g.flagged = !g.flagged;
  state.flagsLeft += g.flagged ? -1 : 1;
  state.lastAction = { type:'flag', idx: i };
  audit('flag', `idx:${i} flagged:${g.flagged}`);
  renderBoard(); updateCounts(); checkWin();
}

/* chord: if number of flags around equals number, reveal neighbors */
function chord(i){
  const g = state.grid[i];
  if(!g.revealed || g.num===0) return;
  const [r,c] = idxToRC(i);
  let flagged=0, toReveal=[];
  for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
    if(dr===0 && dc===0) continue;
    const nr=r+dr, nc=c+dc;
    if(nr>=0 && nr<state.rows && nc>=0 && nc<state.cols){
      const ni = rcToIdx(nr,nc);
      if(state.grid[ni].flagged) flagged++; else if(!state.grid[ni].revealed) toReveal.push(ni);
    }
  }
  if(flagged === g.num){
    for(const n of toReveal){
      if(state.grid[n].mine){ revealAllMines(n); endGame(false); return; }
      floodReveal(n);
    }
    audit('chord', `idx:${i}`);
    renderBoard();
  }
}

/* flood reveal BFS */
function floodReveal(start){
  const q = [start], seen = new Set();
  while(q.length){
    const cur = q.shift();
    if(seen.has(cur)) continue;
    const c = state.grid[cur];
    if(c.revealed || c.flagged) continue;
    c.revealed = true; seen.add(cur); state.revealedCount++;
    if(state.lastAction && state.lastAction.type==='reveal') state.lastAction.indices.push(cur);
    if(c.num === 0 && !c.mine){
      const [r,cc] = idxToRC(cur);
      for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
        if(dr===0 && dc===0) continue;
        const nr=r+dr, nc=cc+dc;
        if(nr>=0 && nr<state.rows && nc>=0 && nc<state.cols){
          const ni = rcToIdx(nr,nc);
          if(!seen.has(ni) && !state.grid[ni].flagged) q.push(ni);
        }
      }
    }
  }
}

/* reveal all mines for loss scenario */
function revealAllMines(clickedIdx){
  for(let i=0;i<state.grid.length;i++) if(state.grid[i].mine) state.grid[i].revealed = true;
  state.gameOver = true; stopTimer();
  const el = boardEl.querySelector(`.cell[data-idx='${clickedIdx}']`);
  if(el) el.style.background = 'linear-gradient(180deg, rgba(255,0,0,0.08), rgba(255,0,0,0.02))';
  audit('reveal_all', clickedIdx);
  renderBoard();
}

/* -------------------- Win / Lose -------------------- */
function checkWin(){
  const total = state.rows * state.cols;
  if(state.revealedCount === total - state.mines){
    endGame(true);
  }
}
function endGame(won){
  state.won = won; state.gameOver = true; stopTimer();
  statusEl.textContent = won ? `You win! ${state.elapsed}s` : 'Boom! You lost';
  if(won){
    confettiBurst();
    addLeaderboardEntry(modeSel.value, playerNameEl.value || 'Anon', state.elapsed);
  }
  audit(won ? 'win' : 'loss', won ? `${state.elapsed}s` : '');
  renderBoard();
}

/* -------------------- Undo (simple) -------------------- */
function undo(){
  const a = state.lastAction;
  if(!a){ alert('Nothing to undo'); return; }
  if(a.type === 'reveal'){ a.indices.forEach(i=>{ if(state.grid[i]) { state.grid[i].revealed=false; state.revealedCount = Math.max(0, state.revealedCount - 1); } }); }
  else if(a.type === 'flag'){ const i = a.idx; if(state.grid[i]){ state.grid[i].flagged = !state.grid[i].flagged; state.flagsLeft += state.grid[i].flagged ? -1 : 1; } }
  state.lastAction = null;
  audit('undo', JSON.stringify(a));
  renderBoard(); updateCounts();
}

/* flash cell */
function flashCell(i){
  const el = boardEl.querySelector(`.cell[data-idx='${i}']`);
  if(!el) return;
  el.animate([{ transform: 'scale(1.04)' }, { transform: 'scale(1)' }], { duration: 180 });
}

/* -------------------- Hints -------------------- */
function useHint(){
  if(state.hintCount <= 0) return alert('No hints left');
  for(let i=0;i<state.grid.length;i++){
    if(!state.grid[i].revealed && !state.grid[i].mine && !state.grid[i].flagged){
      if(state.firstClick){ placeMinesAfterClick(i); state.firstClick = false; state.started = true; startTimer(); }
      floodReveal(i);
      state.hintCount--; audit('hint', `idx:${i}`);
      renderBoard(); updateCounts(); checkWin();
      return;
    }
  }
  alert('No safe hint found');
}

/* -------------------- Leaderboard -------------------- */
function loadLB(){ try{ return JSON.parse(localStorage.getItem(KEY.LB) || '{}'); }catch(e){ return {}; } }
function saveLB(lb){ localStorage.setItem(KEY.LB, JSON.stringify(lb)); }
function addLeaderboardEntry(mode, name, time){
  const lb = loadLB(); if(!lb[mode]) lb[mode]=[];
  lb[mode].push({name: String(name).slice(0,30), time: Number(time), ts: nowISO()});
  lb[mode].sort((a,b)=>a.time-b.time); lb[mode] = lb[mode].slice(0,200);
  saveLB(lb); renderLeaderboard();
  audit('lb_add', `${name}:${time}s`);
}
function renderLeaderboard(){
  const mode = modeSel.value;
  const lb = loadLB()[mode] || [];
  leaderboardEl.innerHTML = '';
  if(lb.length===0){ leaderboardEl.textContent = 'No times yet'; return; }
  lb.slice(0,10).forEach((e,i)=> {
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='6px'; row.style.borderRadius='6px'; row.style.background='linear-gradient(180deg, rgba(0,0,0,0.02), rgba(255,255,255,0.02))';
    row.innerHTML = `<div>${i+1}. ${escapeHtml(e.name)}</div><div style="font-weight:800">${e.time}s</div>`;
    leaderboardEl.appendChild(row);
  });
}
function clearLeaderboard(){ localStorage.removeItem(KEY.LB); renderLeaderboard(); audit('lb_clear','admin'); }

/* -------------------- Admin helpers -------------------- */
function isAdmin(){ return !!sessionStorage.getItem(KEY.ADMIN); }
function setAdminSession(user){ sessionStorage.setItem(KEY.ADMIN, JSON.stringify({user, ts: nowISO()})); adminBadge.style.display='inline-block'; adminUserBadgeTop.textContent = user; audit('admin_login', user); }
function clearAdminSession(){ sessionStorage.removeItem(KEY.ADMIN); adminBadge.style.display='none'; adminUserBadgeTop.textContent = ''; audit('admin_logout',''); }

/* -------------------- Admin action implementations -------------------- */
function adminToggleSoftReveal(enabled){ state.softReveal = enabled; renderBoard(); audit('admin_soft_reveal', enabled); }
function adminSetInvincible(enabled){ state.invincible = enabled; audit('admin_invincible', enabled); }
function adminLockBoard(enabled){ state.locked = enabled; audit('admin_lock', enabled); }
function adminAutoFlag(enabled){
  if(enabled){ for(let i=0;i<state.grid.length;i++) if(state.grid[i].mine) state.grid[i].flagged = true; state.flagsLeft = 0; } else { for(let i=0;i<state.grid.length;i++) state.grid[i].flagged = false; state.flagsLeft = state.mines; }
  renderBoard(); audit('admin_auto_flag', enabled);
}
function adminAutoSolve(){
  // simple deterministic solver
  let iter=0, changed=true;
  while(changed && iter < 800){
    iter++; changed=false;
    for(let i=0;i<state.grid.length;i++){
      const g = state.grid[i]; if(!g.revealed || g.num===0) continue;
      const [r,c] = idxToRC(i);
      let flags=0, hidden=[];
      for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
        if(dr===0 && dc===0) continue;
        const nr=r+dr, nc=c+dc; if(nr<0||nc<0||nr>=state.rows||nc>=state.cols) continue;
        const ni = rcToIdx(nr,nc); if(state.grid[ni].flagged) flags++; else if(!state.grid[ni].revealed) hidden.push(ni);
      }
      if(g.num === flags && hidden.length) { hidden.forEach(h=>{ floodReveal(h); changed=true; }); }
      else if(g.num - flags === hidden.length && hidden.length) { hidden.forEach(h=>{ state.grid[h].flagged = true; state.flagsLeft--; changed=true; }); }
    }
  }
  renderBoard(); audit('admin_auto_solve', `iter:${iter}`);
}

/* admin step reveal safe or mine */
function adminStepRevealSafe(){
  for(let i=0;i<state.grid.length;i++) if(!state.grid[i].revealed && !state.grid[i].mine){ floodReveal(i); renderBoard(); audit('admin_step_safe', i); return; }
}
function adminStepRevealMine(){
  for(let i=0;i<state.grid.length;i++) if(state.grid[i].mine && !state.grid[i].revealed){ state.grid[i].revealed = true; renderBoard(); audit('admin_step_mine', i); return; }
}

/* force win/lose */
function adminForceWin(){ for(let i=0;i<state.grid.length;i++) if(!state.grid[i].mine) state.grid[i].revealed = true; state.revealedCount = state.rows*state.cols - state.mines; endGame(true); audit('admin_force_win',''); }
function adminForceLose(){ revealAllMines(-1); endGame(false); audit('admin_force_lose',''); }

/* freeze/warp/set timer */
let timerFrozen = false;
function adminToggleFreeze(){ if(!timerFrozen){ stopTimer(); timerFrozen = true; audit('admin_freeze','frozen'); } else { startTimer(); timerFrozen=false; audit('admin_freeze','resumed'); } }
function adminWarp60(){ state.elapsed += 60; timeCountEl.textContent = `Time: ${state.elapsed}s`; audit('admin_warp', '+60s'); }
function adminSetTimer(){ const v = parseInt(prompt('Set timer seconds (number):', String(state.elapsed))); if(!isNaN(v)){ state.elapsed = v; timeCountEl.textContent = `Time: ${state.elapsed}s`; if(state.started) state.startTs = Date.now() - v*1000; audit('admin_set_time', v); }}

/* snapshot export/import */
function adminExportSnapshot(){
  const payload = { meta:{ts: nowISO()}, state:{ rows: state.rows, cols: state.cols, mines: state.mines, elapsed: state.elapsed }, grid: state.grid };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'minesight_snapshot.json'; a.click(); URL.revokeObjectURL(url);
  audit('admin_export_snapshot','');
}
function adminImportSnapshotFile(file){
  const reader = new FileReader(); reader.onload = ()=> {
    try{
      const p = JSON.parse(reader.result);
      if(p && Array.isArray(p.grid)){ state.grid = p.grid; state.rows = p.state.rows; state.cols = p.state.cols; state.mines = p.state.mines; renderBoard(); updateCounts(); audit('admin_import_snapshot','ok'); }
      else alert('Invalid snapshot');
    }catch(e){ alert('Snapshot parse failed'); }
  }; reader.readAsText(file);
}

/* manual placement & seed */
function adminApplyManualIndices(comma){
  const parts = String(comma||'').split(',').map(x=>parseInt(x.trim())).filter(x=>!isNaN(x) && x>=0 && x < state.rows*state.cols);
  // remove existing mines, then set new ones
  for(let i=0;i<state.grid.length;i++) state.grid[i].mine = false;
  parts.slice(0, state.mines).forEach(p => state.grid[p].mine = true);
  // recompute numbers
  for(let i=0;i<state.grid.length;i++){
    if(state.grid[i].mine) continue;
    const [r,c] = idxToRC(i); let cnt=0;
    for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){ if(dr===0 && dc===0) continue; const nr=r+dr, nc=c+dc; if(nr>=0&&nr<state.rows&&nc>=0&&nc<state.cols) if(state.grid[rcToIdx(nr,nc)].mine) cnt++; }
    state.grid[i].num = cnt;
  }
  renderBoard(); audit('admin_manual_indices', parts.join(','));
}
function adminApplySeed(s){
  // regenerate with seed (place right away)
  initGrid(state.rows, state.cols, state.mines); placeMinesAfterClick(0, s); state.firstClick = false; renderBoard(); audit('admin_seed_apply', s);
}

/* mass flag/unflag */
function adminMassFlag(){ for(let i=0;i<state.grid.length;i++) if(state.grid[i].mine) state.grid[i].flagged = true; state.flagsLeft = 0; renderBoard(); audit('admin_mass_flag',''); }
function adminMassUnflag(){ for(let i=0;i<state.grid.length;i++) state.grid[i].flagged = false; state.flagsLeft = state.mines; renderBoard(); audit('admin_mass_unflag',''); }

/* export LB & audit */
function adminExportLB(){ const blob = new Blob([localStorage.getItem(KEY.LB) || '{}'], {type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='leaderboard.json'; a.click(); URL.revokeObjectURL(url); audit('admin_export_lb',''); }
function adminExportAudit(){ const blob = new Blob([localStorage.getItem(KEY.AUDIT) || '[]'], {type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='audit.json'; a.click(); URL.revokeObjectURL(url); audit('admin_export_audit',''); }
function adminClearAudit(){ localStorage.removeItem(KEY.AUDIT); renderAdminAudit(); audit('admin_clear_audit',''); }

/* placeholder/extra operator actions (safe, produce audit & small visual) */
const PLACEHOLDERS = ['toggle-confetti','simulate-lag','teleport-player','highlight-probabilities','dump-state','toggle-ai-overlay','spam-entries','invert-board','swap-rows','shuffle-nonmines','annotate-audit','slow-mo-reveal','fast-forward-play','mass-hide-numbers','reveal-temp'];
function runPlaceholder(action){
  audit('admin_placeholder', action);
  boardEl.animate([{ transform:'scale(1.02)'},{ transform:'scale(1)'}],{ duration:240 });
}

/* -------------------- UI wiring -------------------- */
modeSel.addEventListener('change', ()=> {
  customArea.style.display = modeSel.value === 'custom' ? 'block' : 'none';
});
startBtn.addEventListener('click', ()=> {
  const m = modeSel.value;
  if(m==='custom'){ const r = clamp(Number(rowsInput.value||9),5,60), c = clamp(Number(colsInput.value||9),5,120), mm = clamp(Number(minesInput.value||10),1,r*c-1); initGrid(r,c,mm); }
  else { const map = { beginner:[9,9,10], intermediate:[16,16,40], expert:[16,30,99] }; const [r,c,mn] = map[m]; initGrid(r,c,mn); }
});
newGameBtn.addEventListener('click', ()=> startBtn.click());
hintBtn.addEventListener('click', ()=> useHint());
submitScoreBtn.addEventListener('click', ()=> { addLeaderboardEntry(modeSel.value, playerNameEl.value||'Anon', state.elapsed || 0); });
clearLBBtn.addEventListener('click', ()=> { if(confirm('Clear leaderboard?')) clearLeaderboard(); });

toggleCompact.addEventListener('click', ()=> { $('compact').checked = !$('compact').checked; renderBoard(); });
softToggle.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); adminToggleSoftReveal(!state.softReveal); $('adminSoftReveal').checked = state.softReveal; });
copyBtn.addEventListener('click', ()=> {
  navigator.clipboard?.writeText(`${modeSel.value} â€¢ ${state.won?'Win':'Loss'} â€¢ ${state.elapsed}s â€¢ ${state.rows}x${state.cols}`).then(()=>{ copyBtn.textContent = 'Copied!'; setTimeout(()=>copyBtn.textContent='Copy Result',1200);});
});
resetHints.addEventListener('click', ()=> { state.hintCount = 3; audit('reset_hints',''); });

/* keyboard nav (basic) */
let focused = 0;
document.addEventListener('keydown', (e)=> {
  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){
    e.preventDefault();
    moveFocus(e.key);
  }
  if(e.key.toLowerCase()==='f'){ e.preventDefault(); toggleFlag(focused); }
  if(e.key==='Enter' || e.key===' '){ e.preventDefault(); onCellClick(focused); }
});
function moveFocus(key){
  const total = state.rows * state.cols;
  const [r,c] = idxToRC(focused);
  let nr=r, nc=c;
  if(key==='ArrowUp') nr = Math.max(0, r-1);
  if(key==='ArrowDown') nr = Math.min(state.rows-1, r+1);
  if(key==='ArrowLeft') nc = Math.max(0, c-1);
  if(key==='ArrowRight') nc = Math.min(state.cols-1, c+1);
  focused = rcToIdx(nr,nc);
  const el = boardEl.querySelector(`.cell[data-idx='${focused}']`);
  if(el) el.focus();
}

/* long-press for touch flagging */
function setupLongPress(el, onLong){
  let t=null;
  el.addEventListener('touchstart', ()=> { t = setTimeout(()=>{ onLong(); t=null; }, 650); });
  el.addEventListener('touchend', ()=> { if(t) clearTimeout(t); t=null; });
  el.addEventListener('touchmove', ()=> { if(t) clearTimeout(t); t=null; });
}

/* -------------------- Admin UI wiring -------------------- */
openAdminBtn.addEventListener('click', ()=> { if(isAdmin()) openAdmin(); else openLogin(); });
loginClose.addEventListener('click', ()=> closeLogin());
loginSubmit.addEventListener('click', ()=> {
  const u = loginUser.value.trim(), p = loginPass.value;
  if(u === DEMO_ADMIN.user && p === DEMO_ADMIN.pass){ setAdminSession(u); closeLogin(); openAdmin(); } else alert('Invalid credentials');
});
adminLogout.addEventListener('click', ()=> { clearAdminSession(); closeAdmin(); });

adminMode.addEventListener('change', ()=> { adminCustomArea.style.display = adminMode.value === 'custom' ? 'block' : 'none'; });
adminApply.addEventListener('click', ()=> {
  const m = adminMode.value;
  if(m === 'custom'){ const r = clamp(Number(adminRows.value||9),5,60), c = clamp(Number(adminCols.value||9),5,120), mn = clamp(Number(adminMines.value||10),1,r*c-1); initGrid(r,c,mn); }
  else { const map = { beginner:[9,9,10], intermediate:[16,16,40], expert:[16,30,99] }; const [r,c,mn] = map[m]; initGrid(r,c,mn); }
  audit('admin_apply_mode', adminMode.value);
});
adminStart.addEventListener('click', ()=> { startBtn.click(); audit('admin_start_game',''); });

exportSnapshotBtn.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); adminExportSnapshot(); });
importSnapshotBtn.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); importSnapshotInput.click(); });
importSnapshotInput.addEventListener('change', (ev)=> { if(ev.target.files[0]) adminImportSnapshotFile(ev.target.files[0]); });

applySeedBtn.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); adminApplySeed(seedValue.value||Math.floor(Math.random()*999999)); });

freezeTimerBtn.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); adminToggleFreeze(); });
warp60Btn.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); adminWarp60(); });
setTimerBtn.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); adminSetTimer(); });

lbAddBtn.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); adminAddLB(); });
exportLB.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); adminExportLB(); });
clearLBAdmin.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); if(confirm('Clear leaderboard?')) clearLeaderboard(); });

adminSoftReveal.addEventListener('change', (e)=> { if(!isAdmin()) return openLogin(); adminToggleSoftReveal(e.target.checked); });
adminInvincible.addEventListener('change', (e)=> { if(!isAdmin()) return openLogin(); state.invincible = e.target.checked; audit('admin_invincible', e.target.checked); });
adminLock.addEventListener('change', (e)=> { if(!isAdmin()) return openLogin(); adminLockBoard(e.target.checked); });
adminAutoFlag.addEventListener('change', (e)=> { if(!isAdmin()) return openLogin(); adminAutoFlag(e.target.checked); });
adminAutoSolve.addEventListener('change', (e)=> { if(!isAdmin()) return openLogin(); if(e.target.checked) adminAutoSolve(); });
adminGhost.addEventListener('change', (e)=> { if(!isAdmin()) return openLogin(); state.ghost = e.target.checked; audit('admin_ghost', e.target.checked); });
adminStep.addEventListener('change', (e)=> { if(!isAdmin()) return openLogin(); state.stepMode = e.target.checked; audit('admin_stepMode', e.target.checked); });

forceWinBtn.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); adminForceWin(); });
forceLoseBtn.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); adminForceLose(); });
massFlagBtn.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); adminMassFlag(); });
massUnflagBtn.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); adminMassUnflag(); });
stepSafeBtn.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); adminStepRevealSafe(); });
stepMineBtn.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); adminStepRevealMine(); });

applyManualBtn.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); adminApplyManualIndices(manualIndices.value); });
randomizeSeedBtn.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); const s = String(Math.floor(Math.random()*999999)); adminApplySeed(s); alert('Applied seed: '+s); });

exportAuditBtn.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); adminExportAudit(); });
clearAuditBtn.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); if(confirm('Clear audit log?')) adminClearAudit(); });

closeAdminBtn.addEventListener('click', ()=> closeAdmin());

/* placeholder actions buttons creation */
PLACEHOLDERS.forEach(action=>{
  const btn = document.createElement('button'); btn.className = 'action-btn'; btn.textContent = action.replace(/-/g,' ');
  btn.addEventListener('click', ()=> { if(!isAdmin()) return openLogin(); runPlaceholder(action); });
  placeholderActionsEl.appendChild(btn);
});

/* -------------------- Modal open/close helpers -------------------- */
function openLogin(){ loginModal.classList.add('open'); loginModal.style.display='flex'; loginUser.focus(); }
function closeLogin(){ loginModal.classList.remove('open'); loginModal.style.display='none'; loginUser.value=''; loginPass.value=''; }
function openAdmin(){ adminModal.classList.add('open'); adminModal.style.display='flex'; adminUserBadgeTop.textContent = JSON.parse(sessionStorage.getItem(KEY.ADMIN)||'{}').user || 'Admin'; renderAdminAudit(); renderLeaderboard(); }
function closeAdmin(){ adminModal.classList.remove('open'); adminModal.style.display='none'; }

/* -------------------- Render helpers -------------------- */
function updateCounts(){ mineCountEl.textContent = `Mines: ${state.mines}`; flagCountEl.textContent = `Flags: ${Math.max(0, state.mines - state.flagsLeft)}`; timeCountEl.textContent = `Time: ${state.elapsed}s`; }
function renderUIAfterReset(){ statusEl.textContent = 'Ready'; timeCountEl.textContent = 'Time: 0s'; renderLeaderboard(); renderAdminAudit(); }

/* admin audit render */
function renderAdminAudit(){
  const arr = JSON.parse(localStorage.getItem(KEY.AUDIT) || '[]');
  adminAuditEl.innerHTML = '';
  if(arr.length === 0){ adminAuditEl.textContent = 'No admin actions yet'; return; }
  arr.slice(0,200).forEach(a=>{
    const d = document.createElement('div'); d.style.padding='6px'; d.style.borderBottom='1px solid rgba(0,0,0,0.04)'; d.style.fontSize='13px'; d.style.color='var(--muted)';
    d.textContent = `${a.ts} â€” ${a.action}${a.detail?(' â€” ' + a.detail):''}`;
    adminAuditEl.appendChild(d);
  });
}

/* -------------------- Misc small utilities -------------------- */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

/* confetti */
function confettiBurst(){
  const ctx = confettiCanvas.getContext('2d');
  const pieces = []; const colors = ['#2563eb','#ffb400','#ff4d4f','#10b981','#7c3aed'];
  for(let i=0;i<120;i++) pieces.push({x:Math.random()*confettiCanvas.width,y:-Math.random()*200,vx:(Math.random()-0.5)*6,vy:Math.random()*6+2,size:Math.random()*8+6,color:colors[Math.floor(Math.random()*colors.length)],rot:Math.random()*360,rotS:Math.random()*8-4,life:200+Math.random()*400});
  let last = performance.now();
  (function frame(ts){
    const dt = ts - last; last = ts; ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
    for(const p of pieces){ p.x+=p.vx; p.y+=p.vy; p.vy += 0.08; p.rot += p.rotS; p.life -= dt; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180); ctx.fillStyle = p.color; ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size*0.6); ctx.restore(); }
    if(pieces.some(p=>p.life>0 && p.y < confettiCanvas.height+50)) requestAnimationFrame(frame); else ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
  })(last);
}

/* -------------------- Admin LB helpers for UI */
function adminAddLB(){ const n = lbAddName.value || 'Admin'; const t = Number(lbAddTime.value || 0); addLeaderboardEntry(modeSel.value, n, t); }
function adminExportLB(){ const blob = new Blob([localStorage.getItem(KEY.LB) || '{}'], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'leaderboard.json'; a.click(); URL.revokeObjectURL(url); audit('admin_export_lb',''); }

/* -------------------- Admin login restore on page load -------------------- */
(function init(){
  // initial grid
  initGrid(9,9,10);
  renderLeaderboard();
  renderAdminAudit();
  if(sessionStorage.getItem(KEY.ADMIN)){ adminBadge.style.display='inline-block'; adminUserBadgeTop.textContent = JSON.parse(sessionStorage.getItem(KEY.ADMIN)).user; }
  // close modals if click outside
  document.querySelectorAll('.modal').forEach(mod => mod.addEventListener('click', e => { if(e.target===mod){ mod.classList.remove('open'); mod.style.display='none'; } }));
})();

/* -------------------- Admin session handlers -------------------- */
function openLogin(){ loginModal.classList.add('open'); loginModal.style.display='flex'; loginUser.focus(); }
function closeLogin(){ loginModal.classList.remove('open'); loginModal.style.display='none'; loginUser.value=''; loginPass.value=''; }
function openAdmin(){ adminModal.classList.add('open'); adminModal.style.display='flex'; adminUserBadgeTop.textContent = JSON.parse(sessionStorage.getItem(KEY.ADMIN)||'{}').user || 'Admin'; renderAdminAudit(); }
function closeAdmin(){ adminModal.classList.remove('open'); adminModal.style.display='none'; }

function setAdminSession(user){ sessionStorage.setItem(KEY.ADMIN, JSON.stringify({user, ts: nowISO()})); adminBadge.style.display='inline-block'; adminUserBadgeTop.textContent = user; audit('admin_login', user); }
function clearAdmin(){ sessionStorage.removeItem(KEY.ADMIN); adminBadge.style.display='none'; adminUserBadgeTop.textContent=''; audit('admin_logout',''); }

/* wire login buttons after functions defined */
loginSubmit.addEventListener('click', ()=> {
  const u = loginUser.value.trim(), p = loginPass.value;
  if(u === DEMO_ADMIN.user && p === DEMO_ADMIN.pass){ setAdminSession(u); closeLogin(); openAdmin(); } else alert('Invalid credentials');
});
loginClose.addEventListener('click', closeLogin);
adminLogout.addEventListener('click', ()=> { clearAdmin(); closeAdmin(); });

/* -------------------- Utility: seed-based create directly (for admin) -------------------- */
function adminApplySeed(seed){
  initGrid(state.rows, state.cols, state.mines);
  // place mines using seed in place of first click (we pick position 0 as dummy)
  placeMinesAfterClick(0, seed, null);
  state.firstClick = false;
  renderBoard();
  audit('admin_apply_seed', seed);
}

/* -------------------- Helper: idx <-> rc duplicates due to scope */
function idxToRC(i){ return [Math.floor(i / state.cols), i % state.cols]; }
function rcToIdx(r,c){ return r * state.cols + c; }

/* -------------------- Helpers for file import exports on admin UI -------------------- */
importSnapshotInput.addEventListener('change', (ev)=> { if(ev.target.files[0]) adminImportSnapshotFile(ev.target.files[0]); });

/* -------------------- Small security note in console */
console.info("Minesight Pro demo loaded. Admin creds (demo) are Sam / test (client-side only). For production, use secure server-side auth.");

/* -------------------- End of script -------------------- */
</script>
</body>
</html>
